let USER_ROLE = null;
let webAppUrl = null;

document.addEventListener("DOMContentLoaded", function() {
  google.script.run
    .withSuccessHandler(handleLogin)
    .withFailureHandler(handleLoginError)
    .verificarAcceso();
});

function handleLogin(user) {
  const loadingScreen = document.getElementById('loading-screen');
  const appContainer = document.getElementById('app-container');
  const startTime = Date.now();
  const MIN_DURATION = 1000 * 60; // 5 segundos

  function showApp() {
    const elapsedTime = Date.now() - startTime;
    const remainingTime = MIN_DURATION - elapsedTime;

    // Esperamos el tiempo que falte para cumplir los 5 segundos
    setTimeout(() => {
      // Aplicamos una transición suave para desaparecer
      loadingScreen.style.transition = 'opacity 0.5s ease-out';
      loadingScreen.style.opacity = '0';
      
      // Ocultamos completamente el div después de la transición
      setTimeout(() => {
         loadingScreen.style.display = 'none';
      }, 500);

      // Mostramos la aplicación principal
      appContainer.style.visibility = 'visible';
      setupUIForRole();
      setDefaultDates();
      cargarListasDesplegables();
      
      // Aseguramos que se muestre la primera pestaña
      if (USER_ROLE === 'ADMINISTRADOR') {
          showTab('dashboard', document.querySelector('#nav-dashboard a'));
      } else if (USER_ROLE === 'ASISTENTE') {
          showTab('asistencia', document.querySelector('#nav-asistencia a'));
      }

    }, Math.max(0, remainingTime)); // Se asegura de no esperar un tiempo negativo
  }

  // --- Lógica de acceso ---
  if (user && user.rol && user.rol !== 'SIN_ACCESO') {
    USER_ROLE = user.rol;
    webAppUrl = user.url; // <-- Asignamos la URL directamente desde el objeto 'user'

    loadingScreen.style.display = 'none';
    document.getElementById('app-container').style.visibility = 'visible';
    setupUIForRole();
    setDefaultDates();
    cargarListasDesplegables();
    // Ya no necesitamos la llamada separada a getWebAppUrl()
  } else {
    loadingScreen.innerHTML = `<div class="login-card"><h2>Acceso Denegado</h2><p>No tienes permiso para acceder a esta aplicación. Contacta al administrador.</p><p><i>Tu email: ${user.email}</i></p></div>`;
  }
}

function openPonderarPage(){
  if(webAppUrl){
    window.open(webAppUrl + '?page=ponderar', '_blank');
  } else {
    alert("La URL de la aplicación aún no se ha cargado. Por favor, espere un momento y vuelva a intentarlo.");
  }
}

function handleLoginError(error) {
  const loadingScreen = document.getElementById('loading-screen');
  loadingScreen.innerHTML = `<div class="login-card"><h2>Error</h2><p>Ocurrió un error al verificar tu acceso: ${error.message}</p></div>`;
}

function setupUIForRole() {
  if (USER_ROLE === 'ASISTENTE') {
    // 1. Lista de todos los elementos que debemos OCULTAR al Asistente
    const itemsParaOcultar = [
      'header-administracion',
      'nav-proyectos',
      'nav-colaboradores',
      'header-remuneraciones',
      'nav-otroshaberes',
      'nav-bonificaciones',
      'nav-ponderar', // ID que agregamos en el HTML
      'nav-nomina',
      'header-sistema',
      'nav-configuracion'
    ];

    // 2. Recorremos la lista y ocultamos cada elemento
    itemsParaOcultar.forEach(id => {
      const elemento = document.getElementById(id);
      if (elemento) {
        elemento.style.display = 'none';
      }
    });

    // 3. La primera pantalla que verá el Asistente será el Dashboard
    showTab('dashboard', document.querySelector('#nav-dashboard a'));

  } else if (USER_ROLE === 'ADMINISTRADOR') {
    // El Administrador ve todo, así que no ocultamos nada.
    // Su primera pantalla también será el Dashboard.
    showTab('dashboard', document.querySelector('#nav-dashboard a'));
    mostrarColaboradores();
  }
}

function setDefaultDates() {
  const today = new Date();
  document.getElementById("fechaIngreso").valueAsDate = today;
  document.getElementById("fecha-asistencia").valueAsDate = today;
  document.getElementById('nomina-mes').value = today.getMonth() + 1;
  document.getElementById('nomina-anio').value = today.getFullYear();
  document.getElementById('consulta-fecha-desde').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('consulta-fecha-hasta').valueAsDate = today;
}

function showTab(tabName, clickedLink) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if(clickedLink) clickedLink.classList.add('active');

  if (tabName === 'asistencia') {
    cargarVistaAsistencia();
  } else if (tabName === 'consultas') {
    cargarListasDesplegables(); 
  } else if (tabName === 'fondoscaja') {
    cargarListasFondosCaja();
    cargarResumenSaldos();
  } else if (tabName === 'otroshaberes') {
    cargarDatosInicialesOtrosHaberes();
  }
}

function showMessage(containerId, message, type) {
  const container = document.getElementById(containerId);
  if (container) {
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
    if (type !== 'error' && type !== 'info') {
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
  }
}

function cargarListasDesplegables() {
  google.script.run
    .withSuccessHandler(populateDropdowns)
    .withFailureHandler(error => console.error("Error al cargar listas:", error))
    .obtenerListasParaAsistencia();
}

function populateDropdowns(listas) {
  const selectColaboradorConsulta = document.getElementById('consulta-colaborador');
  const selectEstadoEdicion = document.getElementById('edit-estado');
  const selectAsignacionEdicion = document.getElementById('edit-asignacion');

  let colaboradoresOptions = '<option value="TODOS">Todos los colaboradores</option>';
  listas.colaboradores.forEach(col => {
    colaboradoresOptions += `<option value="${col.id}">${col.nombre}</option>`;
  });
  selectColaboradorConsulta.innerHTML = colaboradoresOptions;

  let estadosOptions = '<option value="">Seleccione un estado...</option>';
  listas.estados.forEach(estado => {
    estadosOptions += `<option value="${estado}">${estado}</option>`;
  });
  selectEstadoEdicion.innerHTML = estadosOptions;

  let asignacionesOptions = '<option value="">Seleccione una asignación...</option>';
  if (listas.asignaciones) {
    listas.asignaciones.forEach(asignacion => {
      asignacionesOptions += `<option value="${asignacion}">${asignacion}</option>`;
    });
  }
  if(selectAsignacionEdicion) {
    selectAsignacionEdicion.innerHTML = asignacionesOptions;
  }
}

function registrarColaborador(event) {
  event.preventDefault();
  const colaborador = {
    id: document.getElementById("idColaborador").value,
    nombre: document.getElementById("nombreColaborador").value,
    cargo: document.getElementById("cargoColaborador").value,
    departamento: document.getElementById("deptoColaborador").value,
    fechaIngreso: document.getElementById("fechaIngreso").value,
    sueldoBase: document.getElementById("sueldoBase").value
  };

  showMessage('msgColaborador', 'Registrando, por favor espera...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgColaborador', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formColaborador').reset();
        setDefaultDates();
        mostrarColaboradores();
        cargarListasDesplegables();
      }
    })
    .withFailureHandler(error => showMessage('msgColaborador', `Error: ${error.message}`, 'error'))
    .registrarColaborador(colaborador);
}

function mostrarColaboradores() {
  const loading = document.getElementById('loadingColaboradores');
  const container = document.getElementById('tablaColaboradores');
  loading.style.display = 'block';
  container.innerHTML = '';
  google.script.run
    .withSuccessHandler(data => {
      loading.style.display = 'none';
      if (data.length === 0) {
        container.innerHTML = '<div class="message">No hay colaboradores registrados.</div>';
        return;
      }
      let table = '<table><thead><tr><th>ID</th><th>Nombre</th><th>Cargo</th><th>Sueldo Base</th><th>Estado</th></tr></thead><tbody>';
      data.forEach(col => {
        table += `<tr>
                    <td>${col.id}</td>
                    <td>${col.nombre}</td>
                    <td>${col.cargo}</td>
                    <td>${formatearMoneda(col.sueldoBase)}</td>
                    <td>${col.estado}</td>
                  </tr>`;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage(container.id, `Error: ${error.message}`, 'error');
    })
    .obtenerColaboradores();
}

function formatearMoneda(valor) {
  return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(valor);
}

function consultarAsistencias(event) {
  if (event) event.preventDefault();

  const filtros = {
    fechaDesde: document.getElementById('consulta-fecha-desde').value,
    fechaHasta: document.getElementById('consulta-fecha-hasta').value,
    colaboradorId: document.getElementById('consulta-colaborador').value
  };
  const loading = document.getElementById('loadingConsulta');
  const container = document.getElementById('resultados-consulta');

  loading.style.display = 'block';
  container.innerHTML = '';

  google.script.run
    .withSuccessHandler(resultados => {
        loading.style.display = 'none';
        if (resultados.error) {
            container.innerHTML = `<div class="message error">${resultados.error}</div>`;
            return;
        }
        if (!resultados || resultados.length === 0) {
            container.innerHTML = '<div class="message">No se encontraron registros con esos filtros.</div>';
            return;
        }

        let table = `<table><thead><tr><th>Fecha</th><th>Nombre</th><th>Estado</th><th>Asignación</th><th>Observaciones</th><th>Acción</th></tr></thead><tbody>`;
        resultados.forEach(res => {
            const obsEscapadas = (res.observaciones || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const asignacionEscapada = (res.asignacion || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            table += `
              <tr>
                  <td>${res.fecha}</td>
                  <td>${res.nombreColaborador}</td>
                  <td>${res.estado}</td>
                  <td>${res.asignacion || ''}</td>
                  <td>${res.observaciones}</td>
                  <td>
                    <button class="btn btn-secondary" data-id="${res.idRegistro}" data-estado="${res.estado}" data-asignacion="${asignacionEscapada}" data-obs="${obsEscapadas}" onclick="abrirModalEdicionFromButton(this)">Editar</button>
                  </td>
                </tr>
            `;
        });
        table += '</tbody></table>';
        container.innerHTML = table;
    })
    .consultarAsistencias(filtros);
}

function abrirModalEdicion(idRegistro, estadoActual, asignacionActual, obsActual) {
  document.getElementById('edit-idRegistro').value = idRegistro;
  document.getElementById('edit-estado').value = estadoActual;
  document.getElementById('edit-asignacion').value = asignacionActual;
  document.getElementById('edit-observaciones').value = obsActual;
  document.getElementById('modal-edicion').style.display = 'flex';
}

function abrirModalEdicionFromButton(btn) {
  const id = btn.getAttribute('data-id');
  const estado = btn.getAttribute('data-estado');
  const asignacion = btn.getAttribute('data-asignacion');
  const obs = btn.getAttribute('data-obs');
  abrirModalEdicion(id, estado, asignacion, obs);
}

function cerrarModalEdicion() {
  document.getElementById('modal-edicion').style.display = 'none';
  document.getElementById('msgEdicion').innerHTML = '';
}

function guardarCambiosAsistencia(event) {
  event.preventDefault();
  const datos = {
    idRegistro: document.getElementById('edit-idRegistro').value,
    nuevoEstado: document.getElementById('edit-estado').value,
    nuevaAsignacion: document.getElementById('edit-asignacion').value,
    nuevasObservaciones: document.getElementById('edit-observaciones').value
  };

  showMessage('msgEdicion', 'Guardando...', 'info');

  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgEdicion', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        setTimeout(() => {
          cerrarModalEdicion();
          consultarAsistencias();
        }, 1500);
      }
    })
    .actualizarRegistroAsistencia(datos);
}

function inicializarSistema() {
  showMessage('msgConfig', 'Inicializando sistema...', 'info');
  google.script.run
    .withSuccessHandler(response => showMessage('msgConfig', response, 'success'))
    .withFailureHandler(error => showMessage('msgConfig', `Error: ${error.message}`, 'error'))
    .inicializarSistema();
}

function cargarVistaAsistencia() {
  const fechaSeleccionada = document.getElementById('fecha-asistencia').value;
  google.script.run
    .withSuccessHandler(displayAsistenciaGrid)
    .obtenerDatosParaAsistenciaGrid(fechaSeleccionada);
}

function displayAsistenciaGrid(datos) {
  if (datos.error) {
    showMessage('msgAsistenciaGrid', datos.error, 'error');
    return;
  }

  const inputGrid = document.getElementById('asistencia-input-grid');
  const resultsTable = document.getElementById('asistencia-results-table');

  let inputHtml = `<table><thead><tr><th>Colaborador</th><th>Estado</th><th>Asignación</th><th>Vehículo</th><th>Horas</th><th>Observaciones</th></tr></thead><tbody>`;
  let resultsHtml = `<table><thead><tr><th>Colaborador</th><th>Estado Registrado</th><th>Acción</th></tr></thead><tbody>`;

  const estadosOptions = datos.estados.map(e => `<option value="${e}">${e}</option>`).join('');
  const asignacionesOptions = datos.asignaciones.map(a => `<option value="${a}">${a}</option>`).join('');
  const vehiculosOptions = datos.vehiculos.map(v => `<option value="${v}">${v}</option>`).join('');
  const proyectosOptions = datos.proyectos.map(p => `<option value="${p}">${p}</option>`).join('');

  const colaboradoresSinRegistro = [...datos.colaboradores];

  datos.registrosHoy.forEach(reg => {
    const colaborador = datos.colaboradores.find(c => c.id == reg.colaboradorId);
      if (colaborador) {
      const isoNow = new Date().toISOString();
      resultsHtml += `
        <tr>
          <td>${colaborador.nombre}</td>
          <td>${reg.estado}</td>
          <td><button class="btn btn-secondary" data-id="${reg.idRegistro}" data-fecha="${isoNow}" onclick="solicitarEliminarRegistroFromButton(this)">Editar</button></td>
        </tr>`;
      const index = colaboradoresSinRegistro.findIndex(c => c.id == reg.colaboradorId);
      if (index > -1) colaboradoresSinRegistro.splice(index, 1);
    }
  });

  colaboradoresSinRegistro.forEach(col => {
    inputHtml += `
      <tr id="row-${col.id}">
        <td>${col.nombre}</td>
        <td>
          <select class="asistencia-estado" data-employee-id="${col.id}">
            <option value="">Seleccionar...</option>
            ${estadosOptions}
          </select>
        </td>
        <td>
          <select class="asistencia-asignacion" onchange="toggleProyectoSelect(this)">
            <option value="">Seleccionar...</option>
            ${asignacionesOptions}
          </select>
          <select class="asistencia-proyecto" style="display: none; margin-top: 5px;">
            <option value="">Seleccionar Proyecto...</option>
            ${proyectosOptions}
          </select>
        </td>
        <td>
          <select class="asistencia-vehiculo">
            <option value="">Seleccionar...</option>
            ${vehiculosOptions}
          </select>
        </td>
        <td><input type="number" class="asistencia-horas" value="8" style="width: 80px;"></td>
        <td><input type="text" class="asistencia-obs"></td>
      </tr>`;
  });

  colaboradoresSinRegistro.forEach(col => {
    resultsHtml += `<tr style="background-color: #f8d7da;"><td>${col.nombre}</td><td><strong>PENDIENTE</strong></td><td>-</td></tr>`;
  });

  inputHtml += '</tbody></table>';
  resultsHtml += '</tbody></table>';

  inputGrid.innerHTML = colaboradoresSinRegistro.length > 0 ? inputHtml : '<div class="message success">Todos los colaboradores tienen su asistencia registrada para hoy.</div>';
  resultsTable.innerHTML = resultsHtml;
}

function toggleProyectoSelect(selectElement) {
  const row = selectElement.closest('tr');
  const proyectoSelect = row.querySelector('.asistencia-proyecto');
  proyectoSelect.style.display = selectElement.value === 'PROYECTO' ? 'block' : 'none';
}

function guardarAsistencias() {
  const fechaSeleccionada = document.getElementById('fecha-asistencia').value;
  const selects = document.querySelectorAll('.asistencia-estado');
  const asistenciasParaGuardar = [];

  selects.forEach(select => {
    if (select.value) {
      const row = select.closest('tr');
      const asignacionSelect = row.querySelector('.asistencia-asignacion');
      const proyectoSelect = row.querySelector('.asistencia-proyecto');
      let asignacion = asignacionSelect.value;
      if (asignacion === 'PROYECTO' && proyectoSelect.value) {
        asignacion = `PROYECTO: ${proyectoSelect.value}`;
      }
      asistenciasParaGuardar.push({
        colaboradorId: select.dataset.employeeId,
        estado: select.value,
        asignacion: asignacion,
        vehiculo: row.querySelector('.asistencia-vehiculo').value,
        horas: row.querySelector('.asistencia-horas').value,
        observaciones: row.querySelector('.asistencia-obs').value
      });
    }
  });

  if (asistenciasParaGuardar.length === 0) {
    showMessage('msgAsistenciaGrid', 'No hay nuevos estados de asistencia para cargar.', 'info');
    return;
  }

  showMessage('msgAsistenciaGrid', 'Guardando...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgAsistenciaGrid', response, 'success');
      cargarVistaAsistencia();
    })
    .registrarAsistenciasEnLote(asistenciasParaGuardar, fechaSeleccionada);
}

function solicitarEliminarRegistro(idRegistro, fechaRegistro) {
  if (confirm('¿Está seguro de que desea editar este registro? Se eliminará para que pueda volver a ingresarlo.')) {
    const info = { idRegistro, fechaRegistro };
    google.script.run
      .withSuccessHandler(response => {
        alert(response);
        if (!response.includes('Error')) {
          cargarVistaAsistencia();
        }
      })
      .eliminarRegistroAsistencia(info);
  }
}

function solicitarEliminarRegistroFromButton(btn) {
  const id = btn.getAttribute('data-id');
  const fecha = btn.getAttribute('data-fecha');
  if (confirm('¿Está seguro de que desea editar este registro? Se eliminará para que pueda volver a ingresarlo.')) {
    const info = { idRegistro: id, fechaRegistro: fecha };
    google.script.run
      .withSuccessHandler(response => {
        alert(response);
        if (!response.includes('Error')) {
          cargarVistaAsistencia();
        }
      })
      .eliminarRegistroAsistencia(info);
  }
}

// ===============================================================
// GESTIÓN DE PROYECTOS
// ===============================================================

function registrarProyecto(event) {
  event.preventDefault();
  const proyecto = {
  project_code: document.getElementById('project_code').value,
  project_name: document.getElementById('project_name').value,
  registration_date: document.getElementById('registration_date').value,
  client_name: document.getElementById('client_name').value,
  client_rut: document.getElementById('client_rut').value,
  project_stage: document.getElementById('project_stage').value,
  project_status: document.getElementById('project_status').value,
  client_phone: document.getElementById('client_phone').value,
  contact_phone: document.getElementById('contact_phone').value,
  project_address: document.getElementById('project_address').value,
  project_georeference: document.getElementById('project_georeference').value,
  project_contact: document.getElementById('project_contact').value,
  project_observation: document.getElementById('project_observation').value
};

  showMessage('msgProyecto', 'Registrando proyecto...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgProyecto', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formProyecto').reset();
        document.getElementById('registration_date').valueAsDate = new Date();
        cargarProyectos();
      }
    })
    .withFailureHandler(error => showMessage('msgProyecto', `Error: ${error.message}`, 'error'))
    .registrarProyecto(proyecto);
}

function cancelarEdicion() {
  document.getElementById('formProyecto').reset();
  document.getElementById('registration_date').valueAsDate = new Date();
  document.getElementById('project_code').readOnly = false;
  document.getElementById('btnSubmitProject').textContent = 'Registrar Proyecto';
  document.getElementById('btnCancelEdit').style.display = 'none';

  // Ocultar y reiniciar la opción de duplicar
  document.getElementById('duplicar-container').style.display = 'none';
  document.getElementById('duplicarProyectoCheck').checked = false;

  document.querySelector('#formProyecto').onsubmit = function(e) {
    e.preventDefault();
    registrarProyecto(e);
  };
  showMessage('msgProyecto', '', 'info');
}

function cargarProyectos() {
  const loading = document.getElementById('loadingProyectos');
  const container = document.getElementById('tablaProyectos');
  loading.style.display = 'block';
  container.innerHTML = '';
  
  google.script.run
    .withSuccessHandler(data => {
      loading.style.display = 'none';
      if (data.length === 0) {
        container.innerHTML = '<div class="message">No hay proyectos registrados.</div>';
        return;
      }
      let table = `
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Estado</th>
              <th>Fecha Registro</th>
              <th>Cliente</th>
              <th>RUT Cliente</th>
              <th>Etapa</th>
              <th>Tel. Cliente</th>
              <th>Tel. Contacto</th>
              <th>Dirección</th>
              <th>Georeferencia</th>
              <th>Contacto</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
      `;
      data.forEach(proyecto => {
        const statusClass = proyecto.project_status === 'Proyecto Activo' ? 'status-active' : 
                          proyecto.project_status === 'Proyecto Cerrado' ? 'status-closed' : 'status-scheduled';
        table += `
          <tr data-status="${proyecto.project_status}">
            <td>${proyecto.project_code}</td>
            <td>${proyecto.project_name}</td>
            <td><span class="status-badge ${statusClass}">${proyecto.project_status}</span></td>
            <td>${proyecto.registration_date}</td>
            <td>${proyecto.client_name}</td>
            <td>${proyecto.client_rut}</td>
            <td>${proyecto.project_stage}</td>
            <td>${proyecto.client_phone}</td>
            <td>${proyecto.contact_phone}</td>
            <td>${proyecto.project_address}</td>
            <td>${proyecto.project_georeference}</td>
            <td>${proyecto.project_contact}</td>
            <td>${proyecto.project_observation}</td>
            <td>
              <button class="btn btn-secondary" onclick="editarProyecto('${proyecto.project_code}')">Editar</button>
              <button class="btn btn-danger" onclick="eliminarProyecto('${proyecto.project_code}')">Eliminar</button>
            </td>
          </tr>
        `;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage('tablaProyectos', `Error: ${error.message}`, 'error');
    })
    .obtenerProyectos();
}

function editarProyecto(projectCode) {
  const rows = document.querySelectorAll('#tablaProyectos table tbody tr');
  let targetRow = null;
  
  rows.forEach(row => {
    if (row.cells[0].textContent.trim() === projectCode) {
      targetRow = row;
    }
  });
  
  if (!targetRow) {
    alert('No se pudo encontrar el proyecto para editar');
    return;
  }

  const cells = targetRow.cells;
  
  // Asignar valores según el orden actual de columnas
  document.getElementById('project_code').value = cells[0].textContent.trim();
  document.getElementById('project_name').value = cells[1].textContent.trim();
  
  // Extraer el texto del span con clase status-badge
  const statusBadge = cells[2].querySelector('.status-badge');
  const statusValue = statusBadge ? statusBadge.textContent.trim() : 'Proyecto Activo';
  document.getElementById('project_status').value = statusValue;
  
  document.getElementById('registration_date').value = cells[3].textContent.trim();
  document.getElementById('client_name').value = cells[4].textContent.trim();
  document.getElementById('client_rut').value = cells[5].textContent.trim();
  document.getElementById('project_stage').value = cells[6].textContent.trim();
  document.getElementById('client_phone').value = cells[7].textContent.trim();
  document.getElementById('contact_phone').value = cells[8].textContent.trim();
  document.getElementById('project_address').value = cells[9].textContent.trim();
  document.getElementById('project_georeference').value = cells[10].textContent.trim();
  document.getElementById('project_contact').value = cells[11].textContent.trim();
  document.getElementById('project_observation').value = cells[12].textContent.trim();

  // Configurar el formulario para modo edición
  document.getElementById('project_code').readOnly = true;
  document.querySelector('#formProyecto button[type="submit"]').textContent = 'Actualizar Proyecto';

  document.getElementById('btnCancelEdit').style.display = 'inline-block';
  document.getElementById('duplicar-container').style.display = 'block';
  
  // Cambiar el comportamiento del formulario
  const form = document.querySelector('#formProyecto');
  form.onsubmit = function(e) {
    e.preventDefault();
    actualizarProyecto();
  };
  
  // Hacer scroll al formulario
  document.getElementById('formProyecto').scrollIntoView({ behavior: 'smooth' });
}

function actualizarProyecto() {
  const isDuplicating = document.getElementById('duplicarProyectoCheck').checked;

  const proyecto = {
    project_code: document.getElementById('project_code').value,
    project_name: document.getElementById('project_name').value,
    registration_date: document.getElementById('registration_date').value,
    client_name: document.getElementById('client_name').value,
    client_rut: document.getElementById('client_rut').value,
    project_stage: document.getElementById('project_stage').value,
    project_status: document.getElementById('project_status').value,
    client_phone: document.getElementById('client_phone').value,
    contact_phone: document.getElementById('contact_phone').value,
    project_address: document.getElementById('project_address').value,
    project_georeference: document.getElementById('project_georeference').value,
    project_contact: document.getElementById('project_contact').value,
    project_observation: document.getElementById('project_observation').value
  };

  // Limpiar y restaurar el formulario en una función para no repetir código
  const resetFormToRegisterMode = () => {
      document.getElementById('formProyecto').reset();
      document.getElementById('registration_date').valueAsDate = new Date();
      document.getElementById('project_code').readOnly = false;
      document.querySelector('#formProyecto button[type="submit"]').textContent = 'Registrar Proyecto';
      document.getElementById('btnCancelEdit').style.display = 'none';
      document.getElementById('duplicar-container').style.display = 'none';
      document.getElementById('duplicarProyectoCheck').checked = false;
      const form = document.querySelector('#formProyecto');
      form.onsubmit = function(e) { e.preventDefault(); registrarProyecto(e); };
      cargarProyectos();
  };

  if (isDuplicating) {
    // --- LÓGICA PARA DUPLICAR (LLAMA A registrarProyecto) ---
    showMessage('msgProyecto', 'Creando duplicado del proyecto...', 'info');
    google.script.run
      .withSuccessHandler(response => {
        showMessage('msgProyecto', response, response.includes('correctamente') ? 'success' : 'error');
        if (response.includes('correctamente')) {
          resetFormToRegisterMode();
        }
      })
      .withFailureHandler(error => showMessage('msgProyecto', `Error: ${error.message}`, 'error'))
      .registrarProyecto(proyecto);
  } else {
    // --- LÓGICA ORIGINAL PARA ACTUALIZAR ---
    showMessage('msgProyecto', 'Actualizando proyecto...', 'info');
    google.script.run
      .withSuccessHandler(response => {
        showMessage('msgProyecto', response, response.includes('correctamente') ? 'success' : 'error');
        if (response.includes('correctamente')) {
          resetFormToRegisterMode();
        }
      })
      .withFailureHandler(error => showMessage('msgProyecto', `Error: ${error.message}`, 'error'))
      .actualizarProyecto(proyecto);
  }
}

function eliminarProyecto(projectCode) {
  if (!confirm('¿Está seguro de que desea eliminar este proyecto? Esta acción no se puede deshacer.')) {
    return;
  }

  showMessage('tablaProyectos', 'Eliminando proyecto...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('tablaProyectos', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        cargarProyectos();
      }
    })
    .withFailureHandler(error => showMessage('tablaProyectos', `Error: ${error.message}`, 'error'))
    .eliminarProyecto(projectCode);
}

function buscarProyectos(searchTerm) {
  const rows = document.querySelectorAll('#tablaProyectos table tbody tr');
  searchTerm = searchTerm.toLowerCase();
  
  rows.forEach(row => {
    const text = Array.from(row.cells).map(cell => cell.textContent.toLowerCase()).join(' ');
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

// Cargar proyectos cuando se muestra la pestaña
// ===============================================================
// FUNCIONES PARA FONDOS DE CAJA
// ===============================================================

// REEMPLAZA la función 'cargarListasFondosCaja' existente con esta versión corregida:

function cargarListasFondosCaja() {
  // Cargar tipos de registro para ambos selectores
  google.script.run
    .withSuccessHandler(function(tipos) {
      // 1. Popula el dropdown del formulario de registro
      const selectTipoRegistro = document.getElementById('tipo_registro_caja');
      let tiposOptions = '<option value="">Seleccione un tipo...</option>';
      tipos.forEach(tipo => {
        tiposOptions += `<option value="${tipo}">${tipo}</option>`;
      });
      selectTipoRegistro.innerHTML = tiposOptions;

      // 2. (CORRECCIÓN) Popula también el dropdown del filtro de balance
      const selectTipoBalance = document.getElementById('balance-tipo-movimiento');
      let balanceOptions = '<option value="TODOS">Todos los Tipos</option>';
      tipos.forEach(tipo => {
        balanceOptions += `<option value="${tipo}">${tipo}</option>`;
      });
      selectTipoBalance.innerHTML = balanceOptions;
    })
    .withFailureHandler(function(error) {
      showMessage('msgFondosCaja', `Error al cargar tipos de registro: ${error}`, 'error');
    })
    .obtenerTiposRegistro();

  // Cargar colaboradores (esta parte no cambia)
  google.script.run
    .withSuccessHandler(function(colaboradores) {
      const selectColaborador = document.getElementById('colaborador_caja');
      let colaboradoresOptions = '<option value="">Seleccione un colaborador...</option>';
      colaboradores.forEach(col => {
        colaboradoresOptions += `<option value="${col.id}">${col.nombre}</option>`;
      });
      selectColaborador.innerHTML = colaboradoresOptions;
    })
    .withFailureHandler(function(error) {
      showMessage('msgFondosCaja', `Error al cargar colaboradores: ${error}`, 'error');
    })
    .obtenerColaboradores();
}

function toggleMontoInputs() {
  const tipoMovimiento = document.getElementById('tipo_movimiento').value;
  const montoInput = document.getElementById('monto_caja');
  montoInput.placeholder = tipoMovimiento === 'entrada' ? 'Ingrese el monto a recibir' : 'Ingrese el monto a entregar';
}

// REEMPLAZA la función 'registrarMovimientoCaja' existente con esta:

function registrarMovimientoCaja(event) {
  event.preventDefault();

  const movimiento = {
    idColaborador: document.getElementById('colaborador_caja').value,
    tipoRegistro: document.getElementById('tipo_registro_caja').value,
    tipoMovimiento: document.getElementById('tipo_movimiento').value,
    monto: parseFloat(document.getElementById('monto_caja').value),
    detalle: document.getElementById('detalle_caja').value.trim() // Usamos .trim() para limpiar espacios
  };

  // --- INICIO DE LA VALIDACIÓN ---
  // Si el tipo es "RENDICIONES", el detalle no puede estar vacío.
  if (movimiento.tipoRegistro === 'RENDICIONES' && !movimiento.detalle) {
    showMessage('msgFondosCaja', 'Error: Para las rendiciones, el campo "Detalle de la transacción" es obligatorio.', 'error');
    return; // Detiene la ejecución de la función
  }
  // --- FIN DE LA VALIDACIÓN ---

  showMessage('msgFondosCaja', 'Registrando movimiento...', 'info');

  google.script.run
    .withSuccessHandler(function(response) {
      showMessage('msgFondosCaja', response.message, response.success ? 'success' : 'error');
      const valeActionsContainer = document.getElementById('vale-actions-container');

      if (response.success) {
        document.getElementById('formFondosCaja').reset();
        cargarResumenSaldos(); // Actualiza la tabla de saldos

        if (response.idRegistro && response.pdfUrl) {
          // Si fue una SALIDA y se generó un vale, muestra los botones en su contenedor
          valeActionsContainer.innerHTML = `
            <button class="btn btn-secondary" onclick="enviarCorreoManualmente('${response.idRegistro}')">Enviar Vale por Correo</button>
            <button class="btn" onclick="imprimirVale('${response.pdfUrl}')">Imprimir Vale (PDF)</button>
          `;
        } else {
          // Si fue una ENTRADA o no se generó un vale, limpia el contenedor de botones
          valeActionsContainer.innerHTML = '';
        }
      }
    })
  .registrarMovimientoCaja(movimiento);
}

function enviarCorreoManualmente(idRegistro) {
  const container = document.getElementById('msgFondosCaja');
  showMessage(container.id, 'Enviando correo, por favor espere...', 'info');

  google.script.run
    .withSuccessHandler(function(response) {
      showMessage(container.id, response.message, response.success ? 'success' : 'error');
    })
    .withFailureHandler(function(error) {
      showMessage(container.id, `Error al enviar correo: ${error.message}`, 'error');
    })
    .enviarValePorCorreo(idRegistro);
}
function imprimirVale(url) {
  // Abre el documento en una nueva pestaña; el usuario puede usar la función de impresión del navegador.
  window.open(url, '_blank');
}

function cargarResumenSaldos() {
  const loading = document.getElementById('loadingSaldos');
  const container = document.getElementById('tablaSaldos');
  
  loading.style.display = 'block';
  
  google.script.run
    .withSuccessHandler(function(saldos) {
      if (!saldos || saldos.length === 0) {
        container.innerHTML = '<div class="message info">No hay saldos positivos para mostrar.</div>';
      } else {
        let html = `
          <table>
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Tipo de Registro</th>
                <th>Saldo ($)</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        saldos.forEach(item => {
          html += `
            <tr>
              <td>${item.nombre}</td>
              <td>${item.tipoRegistro}</td>
              <td style="text-align: right">${formatearMoneda(item.saldo)}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }
      loading.style.display = 'none';
    })
    .withFailureHandler(function(error) {
      showMessage('msgFondosCaja', `Error al cargar saldos: ${error}`, 'error');
      loading.style.display = 'none';
    })
    .obtenerResumenSaldos();
}

// Evento de inicialización
document.addEventListener('DOMContentLoaded', function() {
  const tabProyectos = document.getElementById('nav-proyectos');
  if (tabProyectos) {
    tabProyectos.querySelector('a').addEventListener('click', function() {
      setTimeout(cargarProyectos, 100);
    });
  }

  // Agregar evento para cargar fondos de caja
  const tabFondosCaja = document.getElementById('nav-fondoscaja');
  if (tabFondosCaja) {
    tabFondosCaja.querySelector('a').addEventListener('click', function() {
      setTimeout(cargarListasFondosCaja, 100);
      setTimeout(cargarResumenSaldos, 200);
    });
  }
  
    // Agregar evento para la pestaña Bonificaciones
    const tabBonificaciones = document.getElementById('nav-bonificaciones');
    if (tabBonificaciones) {
      tabBonificaciones.querySelector('a').addEventListener('click', function() {
        setTimeout(() => {
          // Establecer fechas por defecto
          const today = new Date();
          document.getElementById('bon-fecha-hasta').valueAsDate = today;
          document.getElementById('bon-fecha-desde').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
          
          // Limpiamos la tabla y el spinner, ya no cargamos automáticamente
          document.getElementById('tablaBonificaciones').innerHTML = '<div class="message info">Seleccione un rango de fechas y presione "Cargar" para ver los resultados.</div>';
          document.getElementById('loadingBonificaciones').style.display = 'none';
        }, 100);
      });
    }
});

  function cargarBonificaciones(event) {
    if (event) event.preventDefault();
    const desde = document.getElementById('bon-fecha-desde').value;
    const hasta = document.getElementById('bon-fecha-hasta').value;
    const filtro = document.getElementById('bon-filtro').value;
    const loading = document.getElementById('loadingBonificaciones');
    const container = document.getElementById('tablaBonificaciones');
    loading.style.display = 'block';
    container.innerHTML = '';

    google.script.run
      .withSuccessHandler(data => {
        loading.style.display = 'none';
        if (!data || data.error) {
          container.innerHTML = `<div class="message error">${data && data.error ? data.error : 'Error desconocido'}</div>`;
          return;
        }
        renderBonificaciones(data);
      })
      .withFailureHandler(err => {
        loading.style.display = 'none';
        container.innerHTML = `<div class="message error">${err.message}</div>`;
      })
      .obtenerBonificaciones(desde, hasta, filtro);
  }

  function renderBonificaciones(data) {
    const container = document.getElementById('tablaBonificaciones');
    if (!data || !data.proyectos || !data.colaboradores) {
      container.innerHTML = '<div class="message">No hay datos para mostrar.</div>';
      return;
    }

    // Construir tabla HTML
    const html = construirTablaBonificaciones(data.proyectos, data.colaboradores, data.matriz);
    container.innerHTML = html;
  }

  function construirTablaBonificaciones(proyectos, colaboradores, matriz) {
    // Cabecera con colaboradores
    let table = '<table><thead><tr><th>Proyecto</th>';
    colaboradores.forEach(col => { table += `<th>${col.nombre} <div style="font-size:0.8em; color:#666">(${col.id})</div></th>`; });
    table += '</tr></thead><tbody>';

    proyectos.forEach(p => {
      table += `<tr><td><strong>${p}</strong></td>`;
      colaboradores.forEach(col => {
        const count = (matriz[p] && matriz[p][col.id]) ? matriz[p][col.id] : 0;
        table += `<td style="text-align:center">${count}</td>`;
      });
      table += '</tr>';
    });

    table += '</tbody></table>';
    return table;
  }

  function guardarBonificacionesHoja() {
    const desde = document.getElementById('bon-fecha-desde').value;
    const hasta = document.getElementById('bon-fecha-hasta').value;
    const filtro = document.getElementById('bon-filtro').value;
    const btn = event && event.target ? event.target : null;
    if (btn) btn.disabled = true;
    showMessage('tablaBonificaciones', 'Guardando en hoja...', 'info');
    google.script.run
      .withSuccessHandler(res => {
        showMessage('tablaBonificaciones', res, res && res.toString().toLowerCase().indexOf('error') === -1 ? 'success' : 'error');
        if (btn) btn.disabled = false;
      })
      .withFailureHandler(err => {
        showMessage('tablaBonificaciones', `Error: ${err.message}`, 'error');
        if (btn) btn.disabled = false;
      })
      .guardarBonificacionesEnHoja(desde, hasta, filtro);
  }

  function filtrarPorEstado(estado) {
  const rows = document.querySelectorAll('#tablaProyectos table tbody tr');
  const buttons = document.querySelectorAll('.btn-filter');
  
  // Actualizar botones activos
  buttons.forEach(btn => btn.classList.remove('active'));
  if (estado === 'TODOS') {
    document.getElementById('filter-todos').classList.add('active');
  } else if (estado === 'Proyecto Activo') {
    document.getElementById('filter-activo').classList.add('active');
  } else if (estado === 'Proyecto Cerrado') {
    document.getElementById('filter-cerrado').classList.add('active');
  } else if (estado === 'Proyecto Programado') {
    document.getElementById('filter-programado').classList.add('active');
  }
  
  // Filtrar filas
  rows.forEach(row => {
    if (estado === 'TODOS') {
      row.style.display = '';
    } else {
      const rowStatus = row.getAttribute('data-status');
      row.style.display = rowStatus === estado ? '' : 'none';
    }
  });

  // Manejar el checkbox de duplicar proyecto
  const duplicarCheck = document.getElementById('duplicarProyectoCheck');
  if(duplicarCheck) {
    duplicarCheck.addEventListener('change', function() {
      const projectCodeInput = document.getElementById('project_code');
      if (this.checked) {
        projectCodeInput.readOnly = false;
        projectCodeInput.focus();
      } else {
        projectCodeInput.readOnly = true;
      }
    });
  }
}


let datosBalanceActual = null; // Variable global para guardar los datos consultados

function consultarBalance(event) {
  if (event) event.preventDefault();

  const filtros = {
    fechaDesde: document.getElementById('balance-fecha-desde').value,
    fechaHasta: document.getElementById('balance-fecha-hasta').value,
    tipoMovimiento: document.getElementById('balance-tipo-movimiento').value
  };

  const loading = document.getElementById('loadingBalance');
  const container = document.getElementById('tablaBalanceContainer');
  const actions = document.getElementById('balance-actions');

  loading.style.display = 'block';
  loading.textContent = 'Consultando balance...';
  container.innerHTML = '';
  actions.style.display = 'none';
  datosBalanceActual = null;

  google.script.run
    .withSuccessHandler(response => {
      loading.style.display = 'none';
      if (response.error) {
        showMessage('msgBalance', response.error, 'error');
        return;
      }
      datosBalanceActual = response; // Guardar datos para exportar
      renderBalanceTabla(response);
      actions.style.display = 'flex';
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage('msgBalance', `Error: ${error.message}`, 'error');
    })
    .obtenerBalanceFiltrado(filtros);
}

function renderBalanceTabla(response) {
  const container = document.getElementById('tablaBalanceContainer');
  if (!response || !response.data || response.data.length === 0) {
    container.innerHTML = '<div class="message info">No se encontraron movimientos con los filtros seleccionados.</div>';
    return;
  }

  // 1. Añadir el encabezado para "Detalle"
  let table = `<table><thead><tr>
                  <th>Fecha</th>
                  <th>Colaborador</th>
                  <th>Entrada</th>
                  <th>Salida</th>
                  <th>Saldo Acumulado</th>
                  <th>Detalle</th>
                </tr></thead><tbody>`;

  response.data.forEach(row => {
    // 2. Añadir la celda con el dato del detalle
    table += `<tr>
                <td>${row.fecha}</td>
                <td>${row.nombre}</td>
                <td style="text-align: right; color: green;">${formatearMoneda(row.entrada)}</td>
                <td style="text-align: right; color: red;">${formatearMoneda(row.salida)}</td>
                <td style="text-align: right; font-weight: bold;">${formatearMoneda(row.saldo)}</td>
                <td>${row.detalle || ''}</td>
              </tr>`;
  });

  // 3. Ajustar los colspan en el pie de página para la nueva columna
  table += `</tbody>
            <tfoot>
              <tr style="background-color: #f0f8fc;">
                <td colspan="2" style="text-align: right; font-weight: bold;">TOTALES</td>
                <td style="text-align: right; font-weight: bold; color: green;">${formatearMoneda(response.summary.totalEntradas)}</td>
                <td style="text-align: right; font-weight: bold; color: red;">${formatearMoneda(response.summary.totalSalidas)}</td>
                <td colspan="2"></td>
              </tr>
              <tr style="background-color: #e8f4f8;">
                <td colspan="5" style="text-align: right; font-weight: bold;">DIFERENCIA (ENTRADAS - SALIDAS)</td>
                <td style="text-align: right; font-weight: bold;">${formatearMoneda(response.summary.diferencia)}</td>
              </tr>
            </tfoot></table>`;
  container.innerHTML = table;
}

function guardarBalance() {
  if (!datosBalanceActual) {
    showMessage('msgBalance', 'Primero debes consultar un balance para poder guardarlo.', 'error');
    return;
  }
  showMessage('msgBalance', 'Guardando datos en la hoja de cálculo...', 'info');

  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        showMessage('msgBalance', res.message, 'success');
      } else {
        showMessage('msgBalance', res.message, 'error');
      }
    })
    .withFailureHandler(err => showMessage('msgBalance', `Error al guardar: ${err.message}`, 'error'))
    .guardarBalanceEnHoja(datosBalanceActual);
}

function exportarBalance() {
  if (!datosBalanceActual) {
    showMessage('msgBalance', 'Primero debes consultar un balance.', 'error');
    return;
  }
  showMessage('msgBalance', 'Generando exportación...', 'info');
  google.script.run
    .withSuccessHandler(res => {
      if(res.success && res.url) {
        showMessage('msgBalance', '¡Exportación lista! Abriendo en nueva pestaña...', 'success');
        window.open(res.url, '_blank');
      } else {
        showMessage('msgBalance', res.message, 'error');
      }
    })
    .withFailureHandler(err => showMessage('msgBalance', `Error: ${err.message}`, 'error'))
    .exportarBalanceComoNuevaHoja(datosBalanceActual);
}

// ===============================================================
// FUNCIONES PARA OTROS HABERES
// ===============================================================

function cargarDatosInicialesOtrosHaberes() {
  // Configurar fechas por defecto para los filtros
  const today = new Date();
  document.getElementById('haber-fecha').valueAsDate = today;
  document.getElementById('haber-filtro-hasta').valueAsDate = today;
  document.getElementById('haber-filtro-desde').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);

  // Cargar las listas desplegables
  google.script.run
    .withSuccessHandler(listas => {
      const selectColaborador = document.getElementById('haber-colaborador');
      let colOptions = '<option value="">Seleccione...</option>';
      listas.colaboradores.forEach(c => { colOptions += `<option value="${c.id}">${c.nombre}</option>`; });
      selectColaborador.innerHTML = colOptions;

      const selectTipo = document.getElementById('haber-tipo');
      let tipoOptions = '<option value="">Seleccione...</option>';
      listas.tiposHaber.forEach(t => { tipoOptions += `<option value="${t}">${t}</option>`; });
      selectTipo.innerHTML = tipoOptions;

      // Una vez cargadas las listas, mostrar la tabla de registros
      mostrarOtrosHaberes();
    })
    .obtenerListasParaOtrosHaberes();
}

function registrarOtroHaber(event) {
  event.preventDefault();
  const haber = {
    fecha: document.getElementById('haber-fecha').value,
    idColaborador: document.getElementById('haber-colaborador').value,
    tipoHaber: document.getElementById('haber-tipo').value,
    monto: document.getElementById('haber-monto').value,
    comentario: document.getElementById('haber-comentario').value
  };

  showMessage('msgOtroHaber', 'Guardando registro...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgOtroHaber', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formOtroHaber').reset();
        document.getElementById('haber-fecha').valueAsDate = new Date(); // Resetear fecha a hoy
        mostrarOtrosHaberes(); // Actualizar la tabla
      }
    })
    .registrarOtroHaber(haber);
}

function mostrarOtrosHaberes() {
  const loading = document.getElementById('loadingOtrosHaberes');
  const container = document.getElementById('tablaOtrosHaberes');
  loading.style.display = 'block';
  container.innerHTML = '';

  const filtros = {
    fechaDesde: document.getElementById('haber-filtro-desde').value,
    fechaHasta: document.getElementById('haber-filtro-hasta').value,
    busqueda: document.getElementById('haber-filtro-busqueda').value
  };

  google.script.run
    .withSuccessHandler(data => {
      loading.style.display = 'none';
      if (data.error) {
        container.innerHTML = `<div class="message error">${data.error}</div>`;
        return;
      }
      if (data.length === 0) {
        container.innerHTML = '<div class="message">No se encontraron registros con los filtros aplicados.</div>';
        return;
      }

      let table = `<table><thead><tr>
                      <th>Fecha</th>
                      <th>Colaborador</th>
                      <th>Tipo de Haber</th>
                      <th>Monto</th>
                      <th>Comentario</th>
                      <th>Acciones</th>
                    </tr></thead><tbody>`;
      data.forEach(item => {
        table += `<tr>
                    <td>${item.fecha}</td>
                    <td>${item.nombreColaborador}</td>
                    <td>${item.tipoHaber}</td>
                    <td>${formatearMoneda(item.monto)}</td>
                    <td>${item.comentario}</td>
                    <td>
                      <button class="btn btn-sm btn-danger" onclick="solicitarEliminarHaber('${item.idHaber}')">Eliminar</button>
                    </td>
                  </tr>`;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .obtenerOtrosHaberes(filtros);
}

function solicitarEliminarHaber(idHaber) {
  if (confirm('¿Está seguro de que desea eliminar este registro? Esta acción no se puede deshacer.')) {
    google.script.run
      .withSuccessHandler(response => {
        alert(response);
        if (response.includes('correctamente')) {
          mostrarOtrosHaberes();
        }
      })
      .eliminarOtroHaber(idHaber);
  }
}

function openNominaPage(){
  if(webAppUrl){
    window.open(webAppUrl + '?page=nomina', '_blank');
  } else {
    alert("La URL de la aplicación aún no se ha cargado. Por favor, espere y vuelva a intentarlo.");
  }
}
// ===============================================================
// FUNCIÓN PARA RESPALDO DEL SISTEMA
// ===============================================================

function iniciarRespaldo() {
  // Deshabilitamos el botón para evitar múltiples clics
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Creando respaldo...';

  showMessage('msgConfig', 'Iniciando proceso de respaldo. Esto puede tardar un momento...', 'info');

  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgConfig', response.message, response.success ? 'success' : 'error');
      // Reactivamos el botón
      btn.disabled = false;
      btn.textContent = 'Crear Respaldo del Sistema';
    })
    .withFailureHandler(error => {
      showMessage('msgConfig', `Error crítico al crear el respaldo: ${error.message}`, 'error');
      // Reactivamos el botón
      btn.disabled = false;
      btn.textContent = 'Crear Respaldo del Sistema';
    })
    .crearRespaldoCompleto();
}
// ===============================================================
// FUNCIÓN PARA SERVIR IMAGEN DESDE GOOGLE DRIVE
// ===============================================================

/**
 * Obtiene una imagen de Google Drive y la convierte a formato Base64 para usarla en HTML.
 * @returns {string} La imagen en formato Data URL (ej: 'data:image/png;base64,iVBORw0KGgo...') o null si hay error.
 */
function obtenerLogoBase64() {
  try {
    // IMPORTANTE: Pega aquí el ID de tu archivo de logo de Google Drive.
    const ID_LOGO_DRIVE = '1PYf-nZI_LLOaHZsbYW5I8XSKOpCGBJu3'; 
    
    const archivo = DriveApp.getFileById(ID_LOGO_DRIVE);
    const blob = archivo.getBlob();
    const tipoContenido = blob.getContentType();
    const base64Data = Utilities.base64Encode(blob.getBytes());
    
    // Devuelve la imagen en un formato que el <img> de HTML puede leer directamente.
    return `data:${tipoContenido};base64,${base64Data}`;

  } catch (e) {
    console.error("Error al obtener el logo desde Drive: " + e.message);
    return null; // Devuelve null si no se pudo cargar la imagen
  }
}