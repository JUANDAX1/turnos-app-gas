let USER_ROLE = null;

document.addEventListener("DOMContentLoaded", function() {
  google.script.run
    .withSuccessHandler(handleLogin)
    .withFailureHandler(handleLoginError)
    .verificarAcceso();
});

function handleLogin(user) {
  const loadingScreen = document.getElementById('loading-screen');
  if (user && user.rol && user.rol !== 'SIN_ACCESO') {
    USER_ROLE = user.rol;
    loadingScreen.style.display = 'none';
    document.getElementById('app-container').style.visibility = 'visible';
    setupUIForRole();
    setDefaultDates();
    cargarListasDesplegables();
  } else {
    loadingScreen.innerHTML = `<div class="login-card"><h2>Acceso Denegado</h2><p>No tienes permiso para acceder a esta aplicación. Contacta al administrador.</p><p><i>Tu email: ${user.email}</i></p></div>`;
  }
}

function handleLoginError(error) {
  const loadingScreen = document.getElementById('loading-screen');
  loadingScreen.innerHTML = `<div class="login-card"><h2>Error</h2><p>Ocurrió un error al verificar tu acceso: ${error.message}</p></div>`;
}

function setupUIForRole() {
  const navColaboradores = document.getElementById('nav-colaboradores');
  const navNomina = document.getElementById('nav-nomina');
  const navConsultas = document.getElementById('nav-consultas');
  const navConfig = document.getElementById('nav-configuracion');
  const navDashboard = document.getElementById('nav-dashboard');

  if (USER_ROLE === 'ASISTENTE') {
    navColaboradores.style.display = 'none';
    navNomina.style.display = 'none';
    navConsultas.style.display = 'none';
    navConfig.style.display = 'none';
    navDashboard.style.display = 'none';
    showTab('asistencia', document.querySelector('#nav-asistencia a'));
  } else if (USER_ROLE === 'ADMINISTRADOR') {
    showTab('dashboard', document.querySelector('#nav-dashboard a'));
    mostrarColaboradores();
  }
}

function setDefaultDates() {
  const today = new Date();
  document.getElementById("fechaIngreso").valueAsDate = today;
  document.getElementById("fecha-asistencia").valueAsDate = today;
  document.getElementById('nomina-mes').value = today.getMonth() + 1;
  document.getElementById('nomina-anio').value = today.getFullYear();
  document.getElementById('consulta-fecha-desde').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('consulta-fecha-hasta').valueAsDate = today;
}

function showTab(tabName, clickedLink) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if(clickedLink) clickedLink.classList.add('active');

  if (tabName === 'asistencia') {
    cargarVistaAsistencia();
  }
}

function showMessage(containerId, message, type) {
  const container = document.getElementById(containerId);
  if (container) {
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
    if (type !== 'error' && type !== 'info') {
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
  }
}

function cargarListasDesplegables() {
  google.script.run
    .withSuccessHandler(populateDropdowns)
    .withFailureHandler(error => console.error("Error al cargar listas:", error))
    .obtenerListasParaAsistencia();
}

function populateDropdowns(listas) {
  const selectColaboradorConsulta = document.getElementById('consulta-colaborador');
  const selectEstadoEdicion = document.getElementById('edit-estado');

  let colaboradoresOptions = '<option value="TODOS">Todos los colaboradores</option>';
  listas.colaboradores.forEach(col => {
    colaboradoresOptions += `<option value="${col.id}">${col.nombre}</option>`;
  });
  selectColaboradorConsulta.innerHTML = colaboradoresOptions;

  let estadosOptions = '<option value="">Seleccione un estado...</option>';
  listas.estados.forEach(estado => {
    estadosOptions += `<option value="${estado}">${estado}</option>`;
  });
  selectEstadoEdicion.innerHTML = estadosOptions;
}

function registrarColaborador(event) {
  event.preventDefault();
  const colaborador = {
    id: document.getElementById("idColaborador").value,
    nombre: document.getElementById("nombreColaborador").value,
    cargo: document.getElementById("cargoColaborador").value,
    departamento: document.getElementById("deptoColaborador").value,
    fechaIngreso: document.getElementById("fechaIngreso").value,
    sueldoBase: document.getElementById("sueldoBase").value
  };

  showMessage('msgColaborador', 'Registrando, por favor espera...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgColaborador', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formColaborador').reset();
        setDefaultDates();
        mostrarColaboradores();
        cargarListasDesplegables();
      }
    })
    .withFailureHandler(error => showMessage('msgColaborador', `Error: ${error.message}`, 'error'))
    .registrarColaborador(colaborador);
}

function mostrarColaboradores() {
  const loading = document.getElementById('loadingColaboradores');
  const container = document.getElementById('tablaColaboradores');
  loading.style.display = 'block';
  container.innerHTML = '';
  google.script.run
    .withSuccessHandler(data => {
      loading.style.display = 'none';
      if (data.length === 0) {
        container.innerHTML = '<div class="message">No hay colaboradores registrados.</div>';
        return;
      }
      let table = '<table><thead><tr><th>ID</th><th>Nombre</th><th>Cargo</th><th>Sueldo Base</th><th>Estado</th></tr></thead><tbody>';
      data.forEach(col => {
        table += `<tr>
                    <td>${col.id}</td>
                    <td>${col.nombre}</td>
                    <td>${col.cargo}</td>
                    <td>${formatearMoneda(col.sueldoBase)}</td>
                    <td>${col.estado}</td>
                  </tr>`;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage(container.id, `Error: ${error.message}`, 'error');
    })
    .obtenerColaboradores();
}

function solicitarCalculoNomina(event) {
  event.preventDefault();
  const mes = document.getElementById('nomina-mes').value;
  const anio = document.getElementById('nomina-anio').value;
  const loading = document.getElementById('loadingNomina');
  const container = document.getElementById('resultadosNomina');

  loading.style.display = 'block';
  container.innerHTML = '';

  google.script.run
    .withSuccessHandler(resultados => {
      loading.style.display = 'none';
      if (resultados.error) {
        container.innerHTML = `<div class="message error">${resultados.error}</div>`;
        return;
      }
      if (!resultados || resultados.length === 0) {
        container.innerHTML = '<div class="message">No se encontraron datos para el período seleccionado.</div>';
        return;
      }
      let table = `
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Sueldo Base</th>
              <th>Días Trab.</th>
              <th>Faltas Injust.</th>
              <th>Sueldo Calculado</th>
            </tr>
          </thead>
          <tbody>
      `;
      resultados.forEach(res => {
        table += `
          <tr>
            <td>${res.nombre}</td>
            <td>${formatearMoneda(res.sueldoBase)}</td>
            <td>${res.diasTrabajados}</td>
            <td>${res.faltasInjustificadas}</td>
            <td><strong>${formatearMoneda(res.sueldoCalculado)}</strong></td>
          </tr>
        `;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage(container.id, `Error: ${error.message}`, 'error');
    })
    .calcularNomina(mes, anio);
}

function formatearMoneda(valor) {
  return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(valor);
}

function consultarAsistencias(event) {
  if (event) event.preventDefault();

  const filtros = {
    fechaDesde: document.getElementById('consulta-fecha-desde').value,
    fechaHasta: document.getElementById('consulta-fecha-hasta').value,
    colaboradorId: document.getElementById('consulta-colaborador').value
  };
  const loading = document.getElementById('loadingConsulta');
  const container = document.getElementById('resultados-consulta');

  loading.style.display = 'block';
  container.innerHTML = '';

  google.script.run
    .withSuccessHandler(resultados => {
        loading.style.display = 'none';
        if (resultados.error) {
            container.innerHTML = `<div class="message error">${resultados.error}</div>`;
            return;
        }
        if (!resultados || resultados.length === 0) {
            container.innerHTML = '<div class="message">No se encontraron registros con esos filtros.</div>';
            return;
        }

        let table = `<table><thead><tr><th>Fecha</th><th>Nombre</th><th>Estado</th><th>Observaciones</th><th>Acción</th></tr></thead><tbody>`;
        resultados.forEach(res => {
            const obsEscapadas = res.observaciones.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            table += `
              <tr>
                <td>${res.fecha}</td>
                <td>${res.nombreColaborador}</td>
                <td>${res.estado}</td>
                <td>${res.observaciones}</td>
                <td>
                  <button class="btn btn-secondary" onclick="abrirModalEdicion(${res.idRegistro}, '${res.estado}', '${obsEscapadas}')">
                    Editar
                  </button>
                </td>
              </tr>
            `;
        });
        table += '</tbody></table>';
        container.innerHTML = table;
    })
    .consultarAsistencias(filtros);
}

function abrirModalEdicion(idRegistro, estadoActual, obsActual) {
  document.getElementById('edit-idRegistro').value = idRegistro;
  document.getElementById('edit-estado').value = estadoActual;
  document.getElementById('edit-observaciones').value = obsActual;
  document.getElementById('modal-edicion').style.display = 'flex';
}

function cerrarModalEdicion() {
  document.getElementById('modal-edicion').style.display = 'none';
  document.getElementById('msgEdicion').innerHTML = '';
}

function guardarCambiosAsistencia(event) {
  event.preventDefault();
  const datos = {
    idRegistro: document.getElementById('edit-idRegistro').value,
    nuevoEstado: document.getElementById('edit-estado').value,
    nuevasObservaciones: document.getElementById('edit-observaciones').value
  };

  showMessage('msgEdicion', 'Guardando...', 'info');

  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgEdicion', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        setTimeout(() => {
          cerrarModalEdicion();
          consultarAsistencias();
        }, 1500);
      }
    })
    .actualizarRegistroAsistencia(datos);
}

function inicializarSistema() {
  showMessage('msgConfig', 'Inicializando sistema...', 'info');
  google.script.run
    .withSuccessHandler(response => showMessage('msgConfig', response, 'success'))
    .withFailureHandler(error => showMessage('msgConfig', `Error: ${error.message}`, 'error'))
    .inicializarSistema();
}

function cargarVistaAsistencia() {
  const fechaSeleccionada = document.getElementById('fecha-asistencia').value;
  google.script.run
    .withSuccessHandler(displayAsistenciaGrid)
    .obtenerDatosParaAsistenciaGrid(fechaSeleccionada);
}

function displayAsistenciaGrid(datos) {
  if (datos.error) {
    showMessage('msgAsistenciaGrid', datos.error, 'error');
    return;
  }

  const inputGrid = document.getElementById('asistencia-input-grid');
  const resultsTable = document.getElementById('asistencia-results-table');

  let inputHtml = `<table><thead><tr><th>Colaborador</th><th>Estado</th><th>Asignación</th><th>Vehículo</th><th>Horas</th><th>Observaciones</th></tr></thead><tbody>`;
  let resultsHtml = `<table><thead><tr><th>Colaborador</th><th>Estado Registrado</th><th>Acción</th></tr></thead><tbody>`;

  const estadosOptions = datos.estados.map(e => `<option value="${e}">${e}</option>`).join('');
  const asignacionesOptions = datos.asignaciones.map(a => `<option value="${a}">${a}</option>`).join('');
  const vehiculosOptions = datos.vehiculos.map(v => `<option value="${v}">${v}</option>`).join('');

  const colaboradoresSinRegistro = [...datos.colaboradores];

  datos.registrosHoy.forEach(reg => {
    const colaborador = datos.colaboradores.find(c => c.id == reg.colaboradorId);
    if (colaborador) {
      resultsHtml += `
        <tr>
          <td>${colaborador.nombre}</td>
          <td>${reg.estado}</td>
          <td><button class="btn btn-secondary" onclick="solicitarEliminarRegistro(${reg.idRegistro}, '${new Date().toISOString()}')">Editar</button></td>
        </tr>`;
      const index = colaboradoresSinRegistro.findIndex(c => c.id == reg.colaboradorId);
      if (index > -1) colaboradoresSinRegistro.splice(index, 1);
    }
  });

  colaboradoresSinRegistro.forEach(col => {
    inputHtml += `
      <tr id="row-${col.id}">
        <td>${col.nombre}</td>
        <td>
          <select class="asistencia-estado" data-employee-id="${col.id}">
            <option value="">Seleccionar...</option>
            ${estadosOptions}
          </select>
        </td>
        <td>
          <select class="asistencia-asignacion">
            <option value="">Seleccionar...</option>
            ${asignacionesOptions}
          </select>
        </td>
        <td>
          <select class="asistencia-vehiculo">
            <option value="">Seleccionar...</option>
            ${vehiculosOptions}
          </select>
        </td>
        <td><input type="number" class="asistencia-horas" value="8" style="width: 80px;"></td>
        <td><input type="text" class="asistencia-obs"></td>
      </tr>`;
  });

  colaboradoresSinRegistro.forEach(col => {
    resultsHtml += `<tr style="background-color: #f8d7da;"><td>${col.nombre}</td><td><strong>PENDIENTE</strong></td><td>-</td></tr>`;
  });

  inputHtml += '</tbody></table>';
  resultsHtml += '</tbody></table>';

  inputGrid.innerHTML = colaboradoresSinRegistro.length > 0 ? inputHtml : '<div class="message success">Todos los colaboradores tienen su asistencia registrada para hoy.</div>';
  resultsTable.innerHTML = resultsHtml;
}

function guardarAsistencias() {
  const fechaSeleccionada = document.getElementById('fecha-asistencia').value;
  const selects = document.querySelectorAll('.asistencia-estado');
  const asistenciasParaGuardar = [];

  selects.forEach(select => {
    if (select.value) {
      const row = select.closest('tr');
      asistenciasParaGuardar.push({
        colaboradorId: select.dataset.employeeId,
        estado: select.value,
        asignacion: row.querySelector('.asistencia-asignacion').value,
        vehiculo: row.querySelector('.asistencia-vehiculo').value,
        horas: row.querySelector('.asistencia-horas').value,
        observaciones: row.querySelector('.asistencia-obs').value
      });
    }
  });

  if (asistenciasParaGuardar.length === 0) {
    showMessage('msgAsistenciaGrid', 'No hay nuevos estados de asistencia para cargar.', 'info');
    return;
  }

  showMessage('msgAsistenciaGrid', 'Guardando...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgAsistenciaGrid', response, 'success');
      cargarVistaAsistencia();
    })
    .registrarAsistenciasEnLote(asistenciasParaGuardar, fechaSeleccionada);
}

function solicitarEliminarRegistro(idRegistro, fechaRegistro) {
  if (confirm('¿Está seguro de que desea editar este registro? Se eliminará para que pueda volver a ingresarlo.')) {
    const info = { idRegistro, fechaRegistro };
    google.script.run
      .withSuccessHandler(response => {
        alert(response);
        if (!response.includes('Error')) {
          cargarVistaAsistencia();
        }
      })
      .eliminarRegistroAsistencia(info);
  }
}

// ===============================================================
// GESTIÓN DE PROYECTOS
// ===============================================================

function registrarProyecto(event) {
  event.preventDefault();
  const proyecto = {
    project_code: document.getElementById('project_code').value,
    project_name: document.getElementById('project_name').value,
    registration_date: document.getElementById('registration_date').value,
    project_address: document.getElementById('project_address').value,
    project_georeference: document.getElementById('project_georeference').value,
    project_contact: document.getElementById('project_contact').value,
    project_observation: document.getElementById('project_observation').value
  };

  showMessage('msgProyecto', 'Registrando proyecto...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgProyecto', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formProyecto').reset();
        document.getElementById('registration_date').valueAsDate = new Date();
        cargarProyectos();
      }
    })
    .withFailureHandler(error => showMessage('msgProyecto', `Error: ${error.message}`, 'error'))
    .registrarProyecto(proyecto);
}

function cancelarEdicion() {
  document.getElementById('formProyecto').reset();
  document.getElementById('registration_date').valueAsDate = new Date();
  document.getElementById('project_code').readOnly = false;
  document.getElementById('btnSubmitProject').textContent = 'Registrar Proyecto';
  document.getElementById('btnCancelEdit').style.display = 'none';
  document.querySelector('#formProyecto').onsubmit = function(e) {
    e.preventDefault();
    registrarProyecto(e);
  };
  showMessage('msgProyecto', '', 'info');
}

function cargarProyectos() {
  const loading = document.getElementById('loadingProyectos');
  const container = document.getElementById('tablaProyectos');
  loading.style.display = 'block';
  container.innerHTML = '';
  
  google.script.run
    .withSuccessHandler(data => {
      loading.style.display = 'none';
      if (data.length === 0) {
        container.innerHTML = '<div class="message">No hay proyectos registrados.</div>';
        return;
      }
      let table = `
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Fecha Registro</th>
              <th>Dirección</th>
              <th>Georeferencia</th>
              <th>Contacto</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
      `;
      data.forEach(proyecto => {
        const obsEscapadas = proyecto.project_observation.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        table += `
          <tr>
            <td>${proyecto.project_code}</td>
            <td>${proyecto.project_name}</td>
            <td>${proyecto.registration_date}</td>
            <td>${proyecto.project_address}</td>
            <td>${proyecto.project_georeference}</td>
            <td>${proyecto.project_contact}</td>
            <td>${proyecto.project_observation}</td>
            <td>
              <div class="actions">
                <button class="btn btn-secondary" onclick="editarProyecto('${proyecto.project_code}')">Editar</button>
                <button class="btn btn-danger" onclick="eliminarProyecto('${proyecto.project_code}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      });
      table += '</tbody></table>';
      container.innerHTML = table;
    })
    .withFailureHandler(error => {
      loading.style.display = 'none';
      showMessage('tablaProyectos', `Error: ${error.message}`, 'error');
    })
    .obtenerProyectos();
}

function editarProyecto(projectCode) {
  const rows = document.querySelectorAll('#tablaProyectos table tbody tr');
  const tableRow = Array.from(rows).find(row => row.cells[0].textContent === projectCode);
  if (!tableRow) return;

  const cells = tableRow.cells;
  document.getElementById('project_code').value = cells[0].textContent;
  document.getElementById('project_name').value = cells[1].textContent;
  document.getElementById('registration_date').value = cells[2].textContent;
  document.getElementById('project_address').value = cells[3].textContent;
  document.getElementById('project_georeference').value = cells[4].textContent;
  document.getElementById('project_contact').value = cells[5].textContent;
  document.getElementById('project_observation').value = cells[6].textContent;

  document.getElementById('project_code').readOnly = true;
  document.getElementById('btnSubmitProject').textContent = 'Actualizar Proyecto';
  document.getElementById('btnCancelEdit').style.display = 'block';
  document.querySelector('#formProyecto').onsubmit = function(e) {
    e.preventDefault();
    actualizarProyecto();
  };
}

function actualizarProyecto() {
  const proyecto = {
    project_code: document.getElementById('project_code').value,
    project_name: document.getElementById('project_name').value,
    registration_date: document.getElementById('registration_date').value,
    project_address: document.getElementById('project_address').value,
    project_georeference: document.getElementById('project_georeference').value,
    project_contact: document.getElementById('project_contact').value,
    project_observation: document.getElementById('project_observation').value
  };

  showMessage('msgProyecto', 'Actualizando proyecto...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('msgProyecto', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        document.getElementById('formProyecto').reset();
        document.getElementById('registration_date').valueAsDate = new Date();
        document.getElementById('project_code').readOnly = false;
        document.querySelector('#formProyecto button[type="submit"]').textContent = 'Registrar Proyecto';
        document.querySelector('#formProyecto').onsubmit = function(e) {
          e.preventDefault();
          registrarProyecto(e);
        };
        cargarProyectos();
      }
    })
    .withFailureHandler(error => showMessage('msgProyecto', `Error: ${error.message}`, 'error'))
    .actualizarProyecto(proyecto);
}

function eliminarProyecto(projectCode) {
  if (!confirm('¿Está seguro de que desea eliminar este proyecto? Esta acción no se puede deshacer.')) {
    return;
  }

  showMessage('tablaProyectos', 'Eliminando proyecto...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      showMessage('tablaProyectos', response, response.includes('correctamente') ? 'success' : 'error');
      if (response.includes('correctamente')) {
        cargarProyectos();
      }
    })
    .withFailureHandler(error => showMessage('tablaProyectos', `Error: ${error.message}`, 'error'))
    .eliminarProyecto(projectCode);
}

function buscarProyectos(searchTerm) {
  const rows = document.querySelectorAll('#tablaProyectos table tbody tr');
  searchTerm = searchTerm.toLowerCase();
  
  rows.forEach(row => {
    const text = Array.from(row.cells).map(cell => cell.textContent.toLowerCase()).join(' ');
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

// Cargar proyectos cuando se muestra la pestaña
document.addEventListener('DOMContentLoaded', function() {
  const tabProyectos = document.getElementById('nav-proyectos');
  if (tabProyectos) {
    tabProyectos.querySelector('a').addEventListener('click', function() {
      setTimeout(cargarProyectos, 100);
    });
  }
});