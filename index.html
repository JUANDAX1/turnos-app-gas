<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style><?!= include('styles.html'); ?></style>
</head>
<body>

  <div class="login-overlay" id="loading-screen">
    <div class="login-card">
      <h2>Sistema de N√≥mina</h2>
      <p>Verificando acceso...</p>
    </div>
  </div>

  <div class="app-container" id="app-container">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>Sistema de N√≥mina</h1>
      </div>
      <ul class="nav-menu">
        <li class="nav-item" id="nav-dashboard"><a class="nav-link" onclick="showTab('dashboard', this)"><span class="nav-icon">üìä</span>Dashboard</a></li>

        <li class="nav-item" id="nav-asistencia"><a class="nav-link" onclick="showTab('asistencia', this)"><span class="nav-icon">‚úÖ</span>Registrar Asistencia</a></li>
        <li class="nav-item" id="nav-consultas"><a class="nav-link" onclick="showTab('consultas', this)"><span class="nav-icon">üîç</span>Consultar Asistencia</a></li>
        <li class="nav-item" id="nav-fondoscaja"><a class="nav-link" onclick="showTab('fondoscaja', this)"><span class="nav-icon">üí∞</span>Fondos de Caja</a></li>

        <li class="nav-item" id="nav-proyectos"><a class="nav-link" onclick="showTab('proyectos', this)"><span class="nav-icon">üèóÔ∏è</span>Registrar Proyectos</a></li>
        <li class="nav-item" id="nav-colaboradores"><a class="nav-link" onclick="showTab('colaboradores', this)"><span class="nav-icon">üßë‚Äçüíº</span>Registrar Colaboradores</a></li>
        
        <li class="nav-item" id="nav-bonificaciones"><a class="nav-link" onclick="showTab('bonificaciones', this)"><span class="nav-icon">üéÅ</span>Dias en Obras</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="openPonderarPage()"><span class="nav-icon">‚öñÔ∏è</span>Ponderar Bonos</a></li>
        <li class="nav-item" id="nav-otroshaberes"><a class="nav-link" onclick="showTab('otroshaberes', this)"><span class="nav-icon">üíµ</span>Otros Haberes</a></li>
        
        <li class="nav-item" id="nav-nomina"><a class="nav-link" onclick="openNominaPage()"><span class="nav-icon">üí∞</span>Calcular N√≥mina</a></li>

        <li class="nav-item" id="nav-configuracion"><a class="nav-link" onclick="showTab('configuracion', this)"><span class="nav-icon">‚öôÔ∏è</span>Configuraci√≥n</a></li>
        
      </ul>
    </nav>

    <div class="main-content">
        <div id="dashboard" class="tab-content">
        <div class="content-header"><h2>Dashboard General</h2></div>
        <div class="content-body">
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="stat-colaboradores">0</div><div class="stat-label">Colaboradores Activos</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-asistencia-hoy">0</div><div class="stat-label">Asistencias Hoy</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-ausencias-hoy">0</div><div class="stat-label">Ausencias Hoy</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-nomina-pendiente">0</div><div class="stat-label">N√≥minas Pendientes</div></div>
          </div>
        </div>
      </div>

      <div id="asistencia" class="tab-content">
        <div class="content-header"><h2>Registro Diario de Asistencia</h2></div>
        <div class="content-body">
          
          <div class="card">
            <div class="card-header">
              Registrar Asistencia para el D√≠a: 
              <input type="date" id="fecha-asistencia" onchange="cargarVistaAsistencia()" style="margin-left: 10px; font-size: 1rem; padding: 5px; width: 180px;">
            </div>
            <div class="card-body">
              <div class="table-container" id="asistencia-input-grid">
                </div>
              <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="guardarAsistencias()">Cargar Asistencias</button>
              </div>
              <div id="msgAsistenciaGrid"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Registros Cargados Hoy</div>
            <div class="card-body">
              <div class="table-container" id="asistencia-results-table">
                </div>
            </div>
          </div>

        </div>
      </div>

      <div id="colaboradores" class="tab-content">
        <div class="content-header"><h2>Gesti√≥n de Colaboradores</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Registrar Nuevo Colaborador</div>
            <div class="card-body">
              <form id="formColaborador" onsubmit="registrarColaborador(event)">
                <div class="form-grid">
                  <div class="form-group"><label for="idColaborador">ID / RUT / C√©dula *</label><input id="idColaborador" type="text" required></div>
                  <div class="form-group"><label for="nombreColaborador">Nombre Completo *</label><input id="nombreColaborador" type="text" required></div>
                  <div class="form-group"><label for="cargoColaborador">Cargo</label><input id="cargoColaborador" type="text"></div>
                  <div class="form-group"><label for="deptoColaborador">Departamento</label><input id="deptoColaborador" type="text"></div>
                  <div class="form-group"><label for="fechaIngreso">Fecha de Ingreso *</label><input id="fechaIngreso" type="date" required></div>
                  <div class="form-group"><label for="sueldoBase">Sueldo Base *</label><input id="sueldoBase" type="number" step="1000" required></div>
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-success">Registrar Colaborador</button>
                  <button type="button" class="btn btn-secondary" onclick="document.getElementById('formColaborador').reset(); setDefaultDates();">Limpiar</button>
                </div>
              </form>
              <div id="msgColaborador"></div>
            </div>
          </div>
          <div class="card">
             <div class="card-header">Lista de Colaboradores</div>
             <div class="card-body">
                <div class="actions"><button class="btn" onclick="mostrarColaboradores()">Actualizar Lista</button></div>
                <div id="loadingColaboradores" class="loading">Cargando...</div>
                <div class="table-container" id="tablaColaboradores"></div>
             </div>
          </div>
        </div>
      </div>

<div id="consultas" class="tab-content">
        <div class="content-header"><h2>Consultar Historial de Asistencia</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Filtros de B√∫squeda</div>
            <div class="card-body">
              <form id="formConsulta" onsubmit="consultarAsistencias(event)" class="form-grid">
                <div class="form-group">
                  <label for="consulta-fecha-desde">Desde</label>
                  <input type="date" id="consulta-fecha-desde" required>
                </div>
                <div class="form-group">
                  <label for="consulta-fecha-hasta">Hasta</label>
                  <input type="date" id="consulta-fecha-hasta" required>
                </div>
                <div class="form-group">
                  <label for="consulta-colaborador">Colaborador</label>
                  <select id="consulta-colaborador"></select>
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                  <button type="submit" class="btn btn-primary" style="width: auto;">Buscar</button>
                </div>
              </form>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Resultados</div>
            <div class="card-body">
              <div id="loadingConsulta" class="loading">Buscando...</div>
              <div class="table-container" id="resultados-consulta"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="login-overlay" id="modal-edicion" style="display: none;">
        <div class="login-card" style="max-width: 500px;">
          <h2>Editar Registro de Asistencia</h2>
          <form id="form-edicion" onsubmit="guardarCambiosAsistencia(event)">
            <input type="hidden" id="edit-idRegistro">
            <div class="form-group">
              <label for="edit-estado">Nuevo Estado</label>
              <select id="edit-estado" required></select>
            </div>
            <div class="form-group">
              <label for="edit-asignacion">Nueva Asignaci√≥n</label>
              <select id="edit-asignacion" required></select>
            </div>
            <div class="form-group">
              <label for="edit-observaciones">Nuevas Observaciones</label>
              <textarea id="edit-observaciones" rows="3"></textarea>
            </div>
            <div class="actions">
              <button type="submit" class="btn btn-success">Guardar Cambios</button>
              <button type="button" class="btn btn-secondary" onclick="cerrarModalEdicion()">Cancelar</button>
            </div>
          </form>
          <div id="msgEdicion" style="margin-top: 15px;"></div>
        </div>
      </div>

      <div id="proyectos" class="tab-content">
        <div class="content-header"><h2>Gesti√≥n de Proyectos</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Registrar Nuevo Proyecto</div>
            <div class="card-body">
              <form id="formProyecto" onsubmit="registrarProyecto(event)">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="project_code">C√≥digo del Proyecto *</label>
                    <input id="project_code" type="text" required>
                  </div>
                  <div class="form-group">
                    <label for="project_name">Nombre Proyecto-Etapa *</label>
                    <input id="project_name" type="text" required>
                  </div>
                  <div class="form-group">
                    <label for="registration_date">Fecha de Registro *</label>
                    <input id="registration_date" type="date" required>
                  </div>
                  <div class="form-group">
                    <label for="client_name">Nombre Cliente</label>
                    <input id="client_name" type="text">
                  </div>
                  <div class="form-group">
                    <label for="client_rut">RUT Cliente</label>
                    <input id="client_rut" type="text">
                  </div>
                  <div class="form-group">
                    <label for="project_stage">Etapa</label>
                    <input id="project_stage" type="text">
                  </div>
                  <div class="form-group">
                    <label for="project_status">Estado del Proyecto</label>
                    <select id="project_status">
                      <option value="Proyecto Activo">Proyecto Activo</option>
                      <option value="Proyecto Cerrado">Proyecto Cerrado</option>
                      <option value="Proyecto Programado">Proyecto Programado</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="client_phone">Tel√©fono Cliente</label>
                    <input id="client_phone" type="tel">
                  </div>
                  <div class="form-group">
                    <label for="contact_phone">Tel√©fono Contacto</label>
                    <input id="contact_phone" type="tel">
                  </div>
                  <div class="form-group">
                    <label for="project_address">Direcci√≥n</label>
                    <input id="project_address" type="text">
                  </div>
                  <div class="form-group">
                    <label for="project_georeference">Georeferencia</label>
                    <input id="project_georeference" type="text">
                  </div>
                  <div class="form-group">
                    <label for="project_contact">Contacto</label>
                    <input id="project_contact" type="text">
                  </div>
                  <div class="form-group">
                    <label for="project_observation">Observaciones</label>
                    <textarea id="project_observation" rows="3"></textarea>
                  </div>
                </div>
                <div class="form-group" id="duplicar-container" style="display: none; background-color: #e8f4f8; padding: 15px; border-radius: 8px; grid-column: 1 / -1;">
                  <label for="duplicarProyectoCheck" style="flex-direction: row; align-items: center; cursor: pointer; color: #0c5460;">
                    <input type="checkbox" id="duplicarProyectoCheck" style="width: auto; margin-right: 10px;">
                    <strong>Duplicar Proyecto:</strong> Si marcas esta opci√≥n, se crear√° un proyecto nuevo con los datos de este formulario. **Recuerda cambiar el "C√≥digo del Proyecto"** para evitar errores.
                  </label>
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-success" id="btnSubmitProject">Registrar Proyecto</button>
                  <button type="button" class="btn btn-secondary" id="btnCancelEdit" style="display: none;" onclick="cancelarEdicion()">Cancelar Edici√≥n</button>
                </div>
              </form>
              <div id="msgProyecto"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span>Lista de Proyectos</span>
                <div class="search-container">
                  <input type="text" id="searchProyectos" placeholder="Buscar proyectos..." onkeyup="buscarProyectos(this.value)">
                  <span class="search-icon">üîç</span>
                </div>
              </div>
              <div class="filter-buttons">
                <button class="btn btn-filter active" onclick="filtrarPorEstado('TODOS')" id="filter-todos">Todos</button>
                <button class="btn btn-filter" onclick="filtrarPorEstado('Proyecto Activo')" id="filter-activo">Proyectos Activos</button>
                <button class="btn btn-filter" onclick="filtrarPorEstado('Proyecto Cerrado')" id="filter-cerrado">Proyectos Cerrados</button>
                <button class="btn btn-filter" onclick="filtrarPorEstado('Proyecto Programado')" id="filter-programado">Proyectos Programados</button>
              </div>
            </div>
            <div class="card-body">
              <div id="loadingProyectos" class="loading">Cargando...</div>
              <div class="table-container" id="tablaProyectos"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="fondoscaja" class="tab-content">
        <div class="content-header"><h2>Gesti√≥n de Fondos de Caja</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Registrar Movimiento</div>
            <div class="card-body">
              <form id="formFondosCaja" onsubmit="registrarMovimientoCaja(event)">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="colaborador_caja">Colaborador</label>
                    <select id="colaborador_caja" required></select>
                  </div>
                  <div class="form-group">
                    <label for="tipo_registro_caja">Tipo de Registro</label>
                    <select id="tipo_registro_caja" required></select>
                  </div>
                  <div class="form-group">
                    <label for="tipo_movimiento">Tipo de Movimiento</label>
                    <select id="tipo_movimiento" required onchange="toggleMontoInputs()">
                      <option value="">Seleccione...</option>
                      <option value="entrada">Entrada</option>
                      <option value="salida">Salida</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="monto_caja">Monto ($)</label>
                    <input type="number" id="monto_caja" required min="0" step="1">
                  </div>
                  <div class="form-group">
                    <label for="detalle_caja">Detalle de la transacci√≥n</label>
                    <textarea id="detalle_caja" required rows="2"></textarea>
                  </div>
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-primary">Registrar Movimiento</button>
                </div>
              </form>
              <div id="msgFondosCaja"></div>
              <div id="vale-actions-container" class="actions" style="margin-top: 15px;"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <span>Resumen de Saldos</span>
              <button class="btn btn-sm btn-secondary" onclick="cargarResumenSaldos()">Actualizar Saldos</button>
            </div>
            <div class="card-body">
              <div id="loadingSaldos" class="loading">Cargando...</div>
              <div class="table-container" id="tablaSaldos"></div>
              <div class="card">
                <div class="card-header">Balance de Movimientos</div>
                <div class="card-body">
                  <form id="formBalance" onsubmit="consultarBalance(event)" class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="form-group">
                      <label for="balance-fecha-desde">Desde</label>
                      <input type="date" id="balance-fecha-desde" required>
                    </div>
                    <div class="form-group">
                      <label for="balance-fecha-hasta">Hasta</label>
                      <input type="date" id="balance-fecha-hasta" required>
                    </div>
                    <div class="form-group">
                      <label for="balance-tipo-movimiento">Tipo de Registro</label>
                      <select id="balance-tipo-movimiento"></select>
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                      <button type="submit" class="btn btn-primary" style="width: auto;">Consultar</button>
                    </div>
                  </form>

                  <div id="loadingBalance" class="loading"></div>
                  <div class="actions" style="margin-top: 20px; display: none;" id="balance-actions">
                    <button class="btn btn-success" onclick="guardarBalance()">Guardar en Hoja</button>
                    <button class="btn" onclick="exportarBalance()">Exportar</button>
                  </div>
                  <div class="table-container" id="tablaBalanceContainer" style="margin-top: 15px;"></div>
                  <div id="msgBalance"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div id="bonificaciones" class="tab-content">
        <div class="content-header"><h2>Bonificaciones por dia</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Filtros</div>
            <div class="card-body">
              <form id="formBonificaciones" onsubmit="cargarBonificaciones(event)" class="form-grid">
                <div class="form-group">
                  <label for="bon-fecha-desde">Desde</label>
                  <input type="date" id="bon-fecha-desde" required>
                </div>
                <div class="form-group">
                  <label for="bon-fecha-hasta">Hasta</label>
                  <input type="date" id="bon-fecha-hasta" required>
                </div>
                <div class="form-group">
                  <label for="bon-filtro">Filtro inteligente</label>
                  <input type="text" id="bon-filtro" placeholder="Buscar por ID o nombre...">
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary">Cargar</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Tabla de dias en Obras</div>
            <div class="card-body">
              <div id="loadingBonificaciones" class="loading">Cargando...</div>
                <div class="table-container" id="tablaBonificaciones"></div>
                <div class="actions" style="margin-bottom:12px;">
                  <button class="btn" onclick="guardarBonificacionesHoja()">Guardar la selecci√≥n de dias</button>
                </div>
                
            </div>
          </div>
        </div>
      </div>

      <div id="ponderarBonos" class="tab-content">
        <div class="content-header"><h2>Ponderaci√≥n de Bonos por Proyecto</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Tabla de Ponderaci√≥n (%)</div>
            <div class="card-body">
              <div class="actions" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="guardarPesosPonderacion(event)">Guardar Pesos</button>
              </div>
              <div id="loadingPonderacion" class="loading">Cargando...</div>
              <div class="table-container" id="tablaPonderacionContainer"></div>
              <div id="msgPonderacion"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="configuracion" class="tab-content">
        <div class="content-header"><h2>Configuraci√≥n del Sistema</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Herramientas</div>
            <div class="card-body">
              <div class="actions">
                <button class="btn btn-success" onclick="inicializarSistema()">Inicializar / Validar Hojas</button>
              </div>
              <div id="msgConfig"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="otroshaberes" class="tab-content">
        <div class="content-header"><h2>Gesti√≥n de Otros Haberes</h2></div>
        <div class="content-body">
          <div class="card">
            <div class="card-header">Registrar Nuevo Haber</div>
            <div class="card-body">
              <form id="formOtroHaber" onsubmit="registrarOtroHaber(event)">
                <div class="form-grid" style="grid-template-columns: 1fr 2fr 1fr 1fr;">
                  <div class="form-group"><label for="haber-fecha">Fecha *</label><input id="haber-fecha" type="date" required></div>
                  <div class="form-group"><label for="haber-colaborador">Colaborador *</label><select id="haber-colaborador" required></select></div>
                  <div class="form-group"><label for="haber-tipo">Tipo de Haber *</label><select id="haber-tipo" required></select></div>
                  <div class="form-group"><label for="haber-monto">Monto (CLP) *</label><input id="haber-monto" type="number" step="1" min="0" required></div>
                </div>
                <div class="form-group">
                  <label for="haber-comentario">Comentario</label>
                  <textarea id="haber-comentario" rows="2"></textarea>
                </div>
                <div class="actions">
                  <button type="submit" class="btn btn-success">Guardar Registro</button>
                </div>
              </form>
              <div id="msgOtroHaber"></div>
            </div>
          </div>

          <div class="card">
             <div class="card-header">Lista de Registros</div>
             <div class="card-body">
                <div class="form-grid" style="margin-bottom: 20px; grid-template-columns: 1fr 1fr 2fr;">
                    <div class="form-group">
                        <label for="haber-filtro-desde">Desde</label>
                        <input type="date" id="haber-filtro-desde" onchange="mostrarOtrosHaberes()">
                    </div>
                    <div class="form-group">
                        <label for="haber-filtro-hasta">Hasta</label>
                        <input type="date" id="haber-filtro-hasta" onchange="mostrarOtrosHaberes()">
                    </div>
                    <div class="form-group">
                        <label for="haber-filtro-busqueda">B√∫squeda r√°pida</label>
                        <input type="text" id="haber-filtro-busqueda" placeholder="Buscar por nombre, tipo, monto..." onkeyup="mostrarOtrosHaberes()">
                    </div>
                </div>
                <div id="loadingOtrosHaberes" class="loading">Cargando...</div>
                <div class="table-container" id="tablaOtrosHaberes"></div>
             </div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

  <script><?!= include('javascript.html'); ?></script>
</body>
</html>