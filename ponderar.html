<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --primary-color: #2E86AB;
      --secondary-color: #5DADE2;
      --background-light: #E8F4F8;
      --background-white: #FAFBFC;
      --text-dark: #34495E;
      --border-color: #E5F2F7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--background-light); padding: 20px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.06); margin-bottom: 25px; border: 1px solid var(--border-color); }
    .card-header { padding: 20px; background: #F0F8FC; border-bottom: 1px solid var(--border-color); font-weight: 600; color: var(--primary-color); font-size: 1.5rem; }
    .card-body { padding: 25px; }
    .table-container { overflow: auto; max-height: 70vh; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 8px 12px; text-align: center; border: 1px solid var(--border-color); white-space: nowrap; }
    th { background: #F0F8FC; font-weight: 600; color: var(--primary-color); position: sticky; top: 0; z-index: 2; }
    td:first-child { text-align: left; font-weight: bold; position: sticky; left: 0; background-color: #F8FBFD; z-index: 1; }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-success { background: #28a745; color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .actions { margin-bottom: 20px; }
    .message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .loading { display: none; text-align: center; padding: 20px; color: var(--secondary-color); font-style: italic; }
    .ponderacion-input { width: 70px; text-align: center; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
    .ponderacion-input:focus { border-color: var(--secondary-color); outline: none; }
  </style>
</head>
<body>

  <div class="card">
    <div class="card-header">Ponderación de Bonos por Proyecto</div>
    <div class="card-body">
      <div class="actions">
        <button class="btn btn-success" id="saveButton" onclick="guardarPesosPonderacion(event)">Guardar Pesos</button>
      </div>
      <div id="msgPonderacion"></div>
      <div id="loadingPonderacion" class="loading">Cargando...</div>
      <div class="table-container" id="tablaPonderacionContainer"></div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    cargarVistaPonderacion();
  });

  function showMessage(containerId, message, type) {
    const container = document.getElementById(containerId);
    if (container) {
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      if (type !== 'error' && type !== 'info') {
        setTimeout(() => { container.innerHTML = ''; }, 5000);
      }
    }
  }

  function cargarVistaPonderacion() {
    const loading = document.getElementById('loadingPonderacion');
    const container = document.getElementById('tablaPonderacionContainer');
    loading.style.display = 'block';
    container.innerHTML = '';
    showMessage('msgPonderacion', 'Cargando datos de proyectos y colaboradores...', 'info');

    google.script.run
      .withSuccessHandler(data => {
        loading.style.display = 'none';
        if (data.error) {
          showMessage('msgPonderacion', `Error al cargar datos: ${data.error}`, 'error');
          return;
        }
        if (!data.proyectos || data.proyectos.length === 0) {
          container.innerHTML = '<div class="message info">No hay proyectos con registros de asistencia para ponderar.</div>';
          return;
        }
        if (!data.trabajadores || data.trabajadores.length === 0) {
          container.innerHTML = '<div class="message info">No hay colaboradores activos para ponderar.</div>';
          return;
        }
        
        generarTablaPonderacion(data.proyectos, data.trabajadores);
        showMessage('msgPonderacion', '', 'info');
      })
      .withFailureHandler(error => {
        loading.style.display = 'none';
        showMessage('msgPonderacion', `Error: ${error.message}`, 'error');
      })
      .obtenerDatosParaPonderacion();
  }

  function generarTablaPonderacion(proyectos, trabajadores) {
    const container = document.getElementById('tablaPonderacionContainer');
    
    let table = '<table id="tabla-ponderacion"><thead><tr><th>Proyecto</th>';
    trabajadores.forEach(t => {
      table += `<th>${t}</th>`;
    });
    table += '</tr></thead><tbody>';

    proyectos.forEach(p => {
      const safeProjectName = p.replace(/"/g, '&quot;');
      table += `<tr data-proyecto="${safeProjectName}"><td>${p}</td>`;
      trabajadores.forEach(t => {
        const safeWorkerName = t.replace(/"/g, '&quot;');
        table += `<td><input type="number" class="ponderacion-input" min="0" max="100" value="0" data-trabajador="${safeWorkerName}"></td>`;
      });
      table += '</tr>';
    });

    table += '</tbody></table>';
    container.innerHTML = table;
  }

  function guardarPesosPonderacion(event) {
    event.preventDefault();
    const btn = document.getElementById('saveButton');
    const tabla = document.getElementById('tabla-ponderacion');
    if (!tabla) {
      showMessage('msgPonderacion', 'La tabla de ponderación no está cargada.', 'error');
      return;
    }

    const pesosGuardados = {};
    const filas = tabla.querySelectorAll('tbody tr');

    filas.forEach(fila => {
      const proyecto = fila.dataset.proyecto;
      if (proyecto) {
        pesosGuardados[proyecto] = {};
        const inputs = fila.querySelectorAll('.ponderacion-input');
        inputs.forEach(input => {
          const trabajador = input.dataset.trabajador;
          const valor = parseInt(input.value, 10);
          if (trabajador && !isNaN(valor)) {
            pesosGuardados[proyecto][trabajador] = valor >= 0 && valor <= 100 ? valor : 0;
          }
        });
      }
    });

    if (Object.keys(pesosGuardados).length === 0) {
      showMessage('msgPonderacion', 'No hay datos para guardar.', 'info');
      return;
    }

    showMessage('msgPonderacion', 'Guardando pesos...', 'info');
    btn.disabled = true;

    google.script.run
      .withSuccessHandler(response => {
        showMessage('msgPonderacion', response, response.includes('correctamente') ? 'success' : 'error');
        btn.disabled = false;
      })
      .withFailureHandler(error => {
        showMessage('msgPonderacion', `Error: ${error.message}`, 'error');
        btn.disabled = false;
      })
      .guardarPonderacion(pesosGuardados);
  }
</script>
</body>
</html>