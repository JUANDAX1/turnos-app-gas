<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style><?!= include('styles.html'); ?></style>

  <style>
    body {
      height: auto; /* Permite que la página crezca en altura */
      overflow: auto; /* Muestra la barra de scroll principal cuando es necesario */
    }
  </style>
</head>
<body>

  <div class="container-fluid mt-4">
      <div id="ponderacion-messages" style="position: sticky; top: 10px; z-index: 1050;"></div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5>Ponderación Estándar por Colaborador</h5>
          <p class="card-subtitle text-muted mb-0">Define el puntaje por defecto para cada colaborador.</p>
        </div>
        <div class="card-body card-body-scrollable" style="max-height: 300px;"> <div id="estandar-table-container">
            <p class="text-center p-3">Cargando...</p>
          </div>
        </div>
        <div class="card-footer">
            <button class="btn btn-primary" onclick="guardarPonderacionEstandar()">Guardar Ponderación Estándar</button>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h4>Cálculo de Bonos por Proyecto</h4>
          <p class="card-subtitle text-muted mb-0">Los proyectos se basan en la última consulta de la pestaña "Bonificaciones". Los pesos se cargan desde la tabla estándar.</p>
        </div>
        <div class="card-body card-body-scrollable">
          <div id="ponderacion-table-container">
            <p class="text-center p-3">Cargando datos de proyectos...</p>
          </div>
        </div>
        <div class="card-footer">
          <button id="btn-calcular-bonos" class="btn btn-success btn-lg mx-2">Calcular Bonos</button>
        </div>
      </div>

      <div id="resultados-card" class="card mt-4" style="display: none;">
        <div class="card-header">
          <h4>Resultados del Cálculo de Bonos</h4>
        </div>
        <div class="card-body card-body-scrollable">
          <div id="tabla-resultados-container"></div>
        </div>
        <div class="card-footer">
          <button id="btn-guardar-bonos" class="btn btn-primary btn-lg mx-2">Guardar Resultados en Hoja</button>
        </div>
      </div>
  </div>

<script>
let datosPonderacionGlobal = null; 
let datosTablaResultados = null; 

document.addEventListener("DOMContentLoaded", function() {
  cargarPonderacionEstandar(); // Carga la nueva tabla primero
  cargarVistaPonderacion(); // Carga la tabla principal
  
  document.getElementById('ponderacion-table-container').addEventListener('click', handlePonderacionTableClick);
  document.getElementById('btn-calcular-bonos').addEventListener('click', iniciarCalculoBonos);
  document.getElementById('resultados-card').addEventListener('click', handleResultadosCardClick);
});

function showPonderacionMessage(message, type, duration = 4000) {
  const container = document.getElementById('ponderacion-messages');
  if (container) {
    const alertType = type === 'success' ? 'alert-success' : (type === 'info' ? 'alert-info' : 'alert-danger');
    // Usamos clases de Bootstrap si están disponibles, si no, un estilo simple
    const alertClasses = `message ${type}`;
    container.innerHTML = `<div class="${alertClasses}" role="alert">${message}</div>`;
    
    // Hacemos que desaparezca
    const alertElement = container.firstChild;
    setTimeout(() => {
        if(alertElement) {
            alertElement.style.transition = 'opacity 0.5s ease';
            alertElement.style.opacity = '0';
            setTimeout(() => { if (container.contains(alertElement)) container.removeChild(alertElement); }, 500);
        }
    }, duration);
  }
}

// --- NUEVAS FUNCIONES PARA PONDERACIÓN ESTÁNDAR ---
function cargarPonderacionEstandar() {
  google.script.run
    .withSuccessHandler(renderPonderacionEstandarTabla)
    .withFailureHandler(error => {
        document.getElementById('estandar-table-container').innerHTML = `<div class="message error">Error al cargar ponderación estándar: ${error.message}</div>`;
    })
    .obtenerPonderacionEstandar();
}

function renderPonderacionEstandarTabla(data) {
    const container = document.getElementById('estandar-table-container');
    if (data.error || !Array.isArray(data)) {
        container.innerHTML = `<div class="message error">${data.error || 'Respuesta inválida del servidor.'}</div>`;
        return;
    }
    if (data.length === 0) {
        container.innerHTML = '<div class="message info">No hay colaboradores para definir ponderación.</div>';
        return;
    }

    let tableHtml = '<table class="table-ponderacion"><thead><tr><th>Nombre</th><th>Cargo</th><th>Ponderación Estándar (%)</th></tr></thead><tbody>';
    data.forEach(col => {
        tableHtml += `
            <tr data-colab-id="${col.id}">
                <td>${col.nombre}</td>
                <td>${col.cargo}</td>
                <td><input type="number" class="form-control ponderacion-input" value="${col.ponderacion}" min="0" max="100"></td>
            </tr>`;
    });
    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;
}

function guardarPonderacionEstandar() {
    const ponderaciones = [];
    document.querySelectorAll('#estandar-table-container tbody tr').forEach(row => {
        ponderaciones.push({
            id: row.dataset.colabId,
            ponderacion: parseInt(row.querySelector('.ponderacion-input').value, 10) || 0
        });
    });

    showPonderacionMessage('Guardando ponderación estándar...', 'info');
    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                showPonderacionMessage(response.message, 'success');
                // Recargar la vista principal para que tome los nuevos valores por defecto
                cargarVistaPonderacion();
            } else {
                showPonderacionMessage(response.message, 'error');
            }
        })
        .withFailureHandler(err => showPonderacionMessage(`Error: ${err.message}`, 'error'))
        .guardarPonderacionEstandar(ponderaciones);
}

// --- FUNCIONES MODIFICADAS Y EXISTENTES ---
function cargarVistaPonderacion() {
  google.script.run
    .withSuccessHandler(renderPonderacionTabla)
    .withFailureHandler(error => {
      showPonderacionMessage(`Error al cargar datos: ${error.message}`, 'error');
      document.getElementById('ponderacion-table-container').innerHTML = `<div class="message error">Error al cargar datos: ${error.message}</div>`;
    })
    .obtenerDatosPonderacion();
}

function renderPonderacionTabla(data) {
  datosPonderacionGlobal = data;
  const container = document.getElementById('ponderacion-table-container');
  
  if (data.error) {
    container.innerHTML = `<div class="message error">Error: ${data.error}</div>`;
    return;
  }
  if (!data.proyectos || data.proyectos.length === 0) {
    container.innerHTML = '<div class="message info">No se encontraron proyectos en la hoja "Bonificaciones". Genere los datos primero.</div>';
    return;
  }
  if (!data.colaboradores || data.colaboradores.length === 0) {
    container.innerHTML = '<div class="message info">No hay colaboradores activos para mostrar.</div>';
    return;
  }

  let tableHtml = '<table class="table-ponderacion"><thead><tr><th>Proyecto</th>';
  data.colaboradores.forEach(c => { tableHtml += `<th>${c.nombre}</th>`; });
  tableHtml += '<th>Bono Proyecto ($)</th><th style="min-width: 190px;">Acciones</th></tr></thead><tbody>';

  data.proyectos.forEach(p => {
    tableHtml += `<tr data-proyecto-nombre="${p.nombre}">`;
    tableHtml += `<td>${p.nombre}</td>`;
    data.colaboradores.forEach(c => {
      // El valor ya viene con el estándar por defecto desde el backend
      const valor = p.ponderaciones[c.id] || 0;
      tableHtml += `<td>
          <span class="valor-ponderacion">${valor}</span>
          <input type="number" class="form-control input-ponderacion ponderacion-input" style="display:none;" value="${valor}" data-colab-id="${c.id}" min="0" max="100">
        </td>`;
    });
    tableHtml += `<td><input type="number" class="form-control bono-proyecto-input" placeholder="Ej: 200000" min="0"></td>`;
    tableHtml += `<td class="btn-action-cell">
        <button class="btn btn-sm btn-primary btn-edit-ponderacion">Editar</button>
        <button class="btn btn-sm btn-success btn-save-ponderacion" style="display:none;">Guardar</button>
        <button class="btn btn-sm btn-secondary btn-cancel-ponderacion" style="display:none;">Cancelar</button>
      </td>`;
    tableHtml += '</tr>';
  });

  tableHtml += '</tbody></table>';
  container.innerHTML = tableHtml;
  showPonderacionMessage('Datos de proyectos cargados.', 'success', 2000);
}

// El resto de funciones (handlePonderacionTableClick, togglePonderacionRow, guardarFilaPonderacion, etc.)
// no necesitan cambios, ya que la lógica principal de edición y cálculo se mantiene.
// Pego las funciones sin cambios para que tengas el archivo completo:

function handlePonderacionTableClick(event) {
  const target = event.target;
  const row = target.closest('tr');
  if (!row) return;

  if (target.classList.contains('btn-edit-ponderacion')) togglePonderacionRow(row, true);
  else if (target.classList.contains('btn-save-ponderacion')) guardarFilaPonderacion(row);
  else if (target.classList.contains('btn-cancel-ponderacion')) togglePonderacionRow(row, false);
}

function togglePonderacionRow(row, isEditing) {
  const spans = row.querySelectorAll('.valor-ponderacion');
  const inputs = row.querySelectorAll('.input-ponderacion');
  const btnEdit = row.querySelector('.btn-edit-ponderacion');
  const btnSave = row.querySelector('.btn-save-ponderacion');
  const btnCancel = row.querySelector('.btn-cancel-ponderacion');

  if (isEditing) {
    spans.forEach((span, index) => {
      span.style.display = 'none';
      inputs[index].style.display = 'block';
      inputs[index].value = span.textContent;
    });
    btnEdit.style.display = 'none';
    btnSave.style.display = 'inline-block';
    btnCancel.style.display = 'inline-block';
  } else {
    spans.forEach(span => span.style.display = 'inline');
    inputs.forEach(input => input.style.display = 'none');
    btnEdit.style.display = 'inline-block';
    btnSave.style.display = 'none';
    btnCancel.style.display = 'none';
  }
}

function guardarFilaPonderacion(row) {
  const btnSave = row.querySelector('.btn-save-ponderacion');
  btnSave.disabled = true;
  btnSave.textContent = 'Guardando...';

  const nombreProyecto = row.dataset.proyectoNombre;
  const ponderaciones = {};
  row.querySelectorAll('.input-ponderacion').forEach(input => {
    ponderaciones[input.dataset.colabId] = parseInt(input.value, 10) || 0;
  });

  google.script.run
    .withSuccessHandler(response => {
      btnSave.disabled = false;
      btnSave.textContent = 'Guardar';
      if (response.success) {
        showPonderacionMessage(`Ponderaciones para '${nombreProyecto}' guardadas.`, 'success');
        row.querySelectorAll('.input-ponderacion').forEach(input => {
          input.closest('td').querySelector('.valor-ponderacion').textContent = input.value;
        });
        togglePonderacionRow(row, false);
      } else {
        showPonderacionMessage(response.message, 'error');
      }
    })
    .withFailureHandler(error => {
      btnSave.disabled = false;
      btnSave.textContent = 'Guardar';
      showPonderacionMessage(`Error al guardar: ${error.message}`, 'error');
    })
    .guardarPonderacionFila({ nombreProyecto, ponderaciones });
}

function iniciarCalculoBonos() {
  showPonderacionMessage('Iniciando cálculo... Obteniendo días trabajados.', 'info', 10000);
  document.getElementById('btn-calcular-bonos').disabled = true;

  google.script.run
    .withSuccessHandler(diasTrabajados => {
        if (diasTrabajados.error) {
            showPonderacionMessage(`Error al obtener días trabajados: ${diasTrabajados.error}`, 'error');
            document.getElementById('btn-calcular-bonos').disabled = false;
            return;
        }
        calcularYRenderizarBonos(diasTrabajados);
    })
    .withFailureHandler(err => {
        showPonderacionMessage(`Error al llamar al backend: ${err.message}`, 'error');
        document.getElementById('btn-calcular-bonos').disabled = false;
    })
    .obtenerDiasTrabajadosBonos();
}

function calcularYRenderizarBonos(diasTrabajados) {
    showPonderacionMessage('Calculando bonos...', 'info', 5000);

    const pesosAsignados = datosPonderacionGlobal.proyectos;
    const bonosPorProyecto = {};
    document.querySelectorAll('#ponderacion-table-container tbody tr').forEach(row => {
        const nombreProyecto = row.dataset.proyectoNombre;
        const bonoInput = row.querySelector('.bono-proyecto-input');
        bonosPorProyecto[nombreProyecto] = parseFloat(bonoInput.value) || 0;
    });

    const colaboradores = datosPonderacionGlobal.colaboradores;
    const proyectos = pesosAsignados.map(p => p.nombre);
    const matrizBonos = {};

    proyectos.forEach(nombreProyecto => {
        matrizBonos[nombreProyecto] = {};
        const bonoFijo = bonosPorProyecto[nombreProyecto] || 0;
        const proyectoData = pesosAsignados.find(p => p.nombre === nombreProyecto);

        if (bonoFijo === 0 || !proyectoData) return;

        let totalPuntosProyecto = 0;
        const puntosPonderados = {};

        colaboradores.forEach(colab => {
            const dias = (diasTrabajados[nombreProyecto] && diasTrabajados[nombreProyecto][colab.id]) ? diasTrabajados[nombreProyecto][colab.id] : 0;
            const peso = proyectoData.ponderaciones[colab.id] || 0;
            const puntos = dias * peso;
            puntosPonderados[colab.id] = puntos;
            totalPuntosProyecto += puntos;
        });

        if (totalPuntosProyecto > 0) {
            colaboradores.forEach(colab => {
                const bono = (puntosPonderados[colab.id] / totalPuntosProyecto) * bonoFijo;
                matrizBonos[nombreProyecto][colab.id] = bono;
            });
        }
    });

    renderResultadosTabla(matrizBonos, proyectos, colaboradores);
    document.getElementById('btn-calcular-bonos').disabled = false;
    showPonderacionMessage('Cálculo de bonos completado.', 'success');
}

function renderResultadosTabla(matrizBonos, proyectos, colaboradores) {
    const container = document.getElementById('tabla-resultados-container');
    document.getElementById('resultados-card').style.display = 'block';

    const totalesColaborador = {};
    colaboradores.forEach(c => totalesColaborador[c.id] = 0);
    let granTotal = 0;

    let tableHtml = '<table class="table-ponderacion"><thead><tr><th>Proyecto</th>';
    colaboradores.forEach(c => { tableHtml += `<th>${c.nombre}</th>`; });
    tableHtml += '<th class="bono-total-col">Total Proyecto</th></tr></thead><tbody>';

    proyectos.forEach(p => {
        let totalProyecto = 0;
        tableHtml += `<tr><td><strong>${p}</strong></td>`;
        colaboradores.forEach((c) => {
            const bono = (matrizBonos[p] && matrizBonos[p][c.id]) ? matrizBonos[p][c.id] : 0;
            tableHtml += `<td>${formatearMoneda(bono)}</td>`;
            totalProyecto += bono;
            totalesColaborador[c.id] += bono;
        });
        granTotal += totalProyecto;
        tableHtml += `<td class="bono-total-col">${formatearMoneda(totalProyecto)}</td>`;
        tableHtml += '</tr>';
    });

    tableHtml += '</tbody><tfoot><tr class="table-secondary"><td><strong>Total Colaborador</strong></td>';
    colaboradores.forEach(c => {
        tableHtml += `<td><strong>${formatearMoneda(totalesColaborador[c.id])}</strong></td>`;
    });
    tableHtml += `<td class="bono-total-col"><strong>${formatearMoneda(granTotal)}</strong></td>`;
    tableHtml += '</tr></tfoot></table>';
    
    // Preparar datos para guardar en hoja
    const headerRow = ['Proyecto', ...colaboradores.map(c => c.nombre), 'Total Proyecto'];
    const dataRows = proyectos.map(p => {
        const row = [p];
        let totalProyecto = 0;
        colaboradores.forEach(c => {
            const bono = (matrizBonos[p] && matrizBonos[p][c.id]) ? matrizBonos[p][c.id] : 0;
            row.push(bono.toFixed(2));
            totalProyecto += bono;
        });
        row.push(totalProyecto.toFixed(2));
        return row;
    });
    const footerRowValues = colaboradores.map(c => totalesColaborador[c.id].toFixed(2));
    const footerRow = ['Total Colaborador', ...footerRowValues, granTotal.toFixed(2)];
    datosTablaResultados = [headerRow, ...dataRows, footerRow];

    container.innerHTML = tableHtml;
}

function formatearMoneda(valor) {
  if (typeof valor !== 'number') return '$0';
  return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(valor);
}

function handleResultadosCardClick(event) {
    if (event.target.id === 'btn-guardar-bonos') {
        guardarBonosEnHoja();
    }
}

function guardarBonosEnHoja() {
    if (!datosTablaResultados) {
        showPonderacionMessage('No hay datos de resultados para guardar.', 'error');
        return;
    }
    const btn = document.getElementById('btn-guardar-bonos');
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    showPonderacionMessage('Guardando resultados en la hoja de cálculo...', 'info');

    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                showPonderacionMessage(response.message, 'success');
            } else {
                showPonderacionMessage(response.message, 'error');
            }
            btn.disabled = false;
            btn.textContent = 'Guardar en Hoja';
        })
        .withFailureHandler(error => {
            showPonderacionMessage(`Error al guardar: ${error.message}`, 'error');
            btn.disabled = false;
            btn.textContent = 'Guardar en Hoja';
        })
        .guardarBonosAPagar(datosTablaResultados);
}
</script>

</body>
</html>